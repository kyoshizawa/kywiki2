
### 5.1 接続管理

| 機能 | 内容 |
|------|------|
| 常時 Listen | CAFIS/CARDNET からの接続を受け付ける（自社がサーバー側） |
| 接続状態管理 | 状態マシン（DISCONNECTED → CONNECTING → CONNECTED → DISCONNECTING → ERROR） |
| 排他制御 | 開局/閉局時に業務処理との同時実行を防止 |

### 5.2 セッション管理

| 機能 | 内容 |
|------|------|
| セッションプール | 複数セッションの保持・管理 |
| 自動再生成 | セッション障害時に全セッションを閉じて再オープン |
| セッション枯渇対応 | セッション ID 不足時の再構築 |

:::info
現行 AP03 はセッション管理を FEXICS の JNI API 経由で行っている。
新システムでは Gateway Service 自体がセッションを管理する。
:::

### 5.3 電文変換

| 機能 | 内容 |
|------|------|
| リクエスト変換 | 業務アプリ形式 → CAFIS/CARDNET 電文形式 |
| レスポンス変換 | CAFIS/CARDNET 電文形式 → 業務アプリ形式 |
| レスポンス解析 | 応答電文のエラーコード検証、確認番号チェック |

### 5.4 障害対応

| 機能 | 内容 |
|------|------|
| 障害取消の自動送信 | 送信成功後にエラーが発生した場合、自動的に SystemCancel を送信（金融整合性の保証） |
| A1/A2系切替 | 回線系切替 |
| タイムアウト制御 | 応答待ちタイムアウト（現行: 90秒） |
| リトライ | 通信エラー時の再試行 |
| リカバリ | 接続断時の自動再接続シーケンス |

### 5.5 監視

| 機能 | 内容 |
|------|------|
| 接続先状態監視 | CAFIS/CARDNET 側の状態変化を検知（現行 AP03 の DaemonEventChkThread に相当） |
| ヘルスチェック応答 | Routing Engine / 外部監視からの死活確認に応答 |

---

## 6. Gateway Service（CAFIS）

### 6.1 対応コマンド

ソースコード調査（AP02 + AP03）に基づく CAFIS 向けコマンド一覧。

#### 決済処理

| コマンド | 機能 | 備考 |
|----------|------|------|
| B01 | iD アクセスキー取得 | iD 決済で使用 |
| B11 | iD オンラインオーソリ | |
| B12 | iD オーソリ取消 | |
| B16 | MS（磁気）オンラインオーソリ | |
| B17 | MS オーソリ取消 | |
| B22 | IC オンラインオーソリ | SecureIC、Global Action からも利用 |
| B23 | IC オーソリ取消 | SecureIC、Global Action からも利用 |
| B24 | アドバイス（取引確定） | IC / SecureIC で使用 |
| B25 | 障害取消 | 障害時の取引復旧 |

#### システム制御

| コマンド | 機能 | 備考 |
|----------|------|------|
| C01 | 開局（接続確立） | |
| C02 | 閉局（接続切断） | |
| C03 | ステータス取得 | ヘルスチェックにも使用 |
| C11 | 締め日取得 | 日次更新 |
| C12 | 締め日更新 | 日次更新 |

#### 対象外

| コマンド | 機能 | 理由 |
|----------|------|------|
| B20, B21 | 銀聯オーソリ / 取消 | ほぼ未使用のため対象外 |
| B30〜B33 | 売上オーソリ系 | 未使用のため対象外 |

### 6.2 接続仕様

| 項目 | 仕様 |
|------|------|
| 接続先 | CAFIS（NTTDATA） |
| 外部向けポート | 2010 |
| 接続方向 | CAFIS から接続を受ける（自社が Listen） |
| 接続コード | 2s30809-000x |

---

## 7. Gateway Service（CARDNET）

### 7.1 対応コマンド

ソースコード調査（AP22）に基づく CARDNET 向けコマンド一覧。

#### 決済処理

| コマンド | 機能 | 備考 |
|----------|------|------|
| OnlineAuthICC | IC オンラインオーソリ | CAFIS の B22 相当 |
| OnlineAuthICC_Cancel | IC オーソリ取消 | CAFIS の B23 相当 |
| SystemCancel | 障害取消 | CAFIS の B25 相当 |

#### システム制御

| コマンド | 機能 | 備考 |
|----------|------|------|
| SignOn | 開局 | CAFIS の C01 相当 |
| SignOff | 閉局 | CAFIS の C02 相当 |
| GetStatus | ステータス取得 | CAFIS の C03 相当 |
| CutOver | 日次更新 | CAFIS の C12 相当 |
| Echo | 死活確認（ハートビート） | CAFIS 側には対応なし |

### 7.2 接続仕様

| 項目 | 仕様 |
|------|------|
| 接続先 | CARDNET（JCN） |
| 外部向けポート | 2200 |
| 接続方向 | CARDNET から接続を受ける（自社が Listen） |
| 接続コード | 3M308090001 |

### 7.3 固有処理

| 処理 | 内容 |
|------|------|
| Saison カード対応 | ICC データの 9F02 タグゼロ設定、9F5A タグ除去 |
| AMEX テスト対応 | テスト環境での ORG_CODE_CARDNET 送信 |
| BIT62 データ解析 | JCB / Saison のカスタムレスポンス解析 |
| カード有効性キャッシュ | 14日間のカード有効性結果キャッシュ |
| モード切替 | TEST / PRODUCTION の動的切替 |

---

## 8. 業務アプリ側の変更

### 8.1 AP02（CAFIS業務処理サービス）

| 項目 | 現行 | 変更後 |
|------|------|--------|
| 接続先 | AP03 (TCP:7000) | Routing Engine (TCP:7000) |
| 変更内容 | 接続先の設定変更 | ポート番号維持のため設定変更のみ |

### 8.2 AP22（CARDNET業務サービス）

| 項目 | 現行 | 変更後 |
|------|------|--------|
| 接続先 | FEXICS (DLL直接呼出し) | Routing Engine (TCP:5000) |
| 変更内容 | FexicsAPI_CN パッケージの利用 | TCP クライアントへの置き換え |

:::caution
AP22 は現行で FEXICS DLL を直接呼び出しているため、AP02 と比べて**変更範囲が大きい**。
FexicsServiceRepository の IFexicsServiceRepository インターフェースを維持しつつ、
内部実装を TCP 通信に置き換える方針とする。
:::
