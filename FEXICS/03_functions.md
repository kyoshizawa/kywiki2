# 機能要件

## 改訂履歴

| バージョン | 日付       | 改定内容 | 改定者 |
| ---------- | ---------- | -------- | ------ |
| v0.1       | 2026-02-03 | 初版作成 | k_yoshizawa |

---

## 1. 機能要件

本ドキュメントでは、FEXICS代替として新規開発する **Routing Engine** および **Gateway Service** の機能要件を定義する。  
機能の洗い出しは、既存コンポーネント（AP02, AP03, AP22）のソースコード調査結果に基づく。

#### 記載対象

| コンポーネント | 役割 |
|---------------|------|
| **Routing Engine** | 業務アプリからの電文を受信し、適切な Gateway Service に振り分ける |
| **Gateway Service** | CAFIS/CARDNET との接続管理および電文変換を行う。決済ネットワーク事業者 = MC間の契約回線ごとに配置 |

#### INDEX

- [共通事項](#2-共通事項)
  - 実行環境
  - ログ要件
- Routing Engine
  - 死活監視 
- Gateway Service
  - 接続センターによる通信仕様変更
  - 開発環境モード

---

## 2. 共通事項

### 2.1 ログ要件

#### フォーマット

- フォーマットは Json 形式。以下のフィールドを含むこと。

| カラム | 内容 |
|--------|------|
| app | アプリケーション識別 |
| level | ログレベル |
| function | 機能識別 |
| message | 内容 |

**サンプル**
```
{"app": "AP26", "level": "INFO", "function": "Main", "message": "アプリケーションを終了します"}
```

#### 出力先

- ECS 動作を想定し、出力先は **console（標準出力）** とする。  
  これにより CloudWatch Logs に記録される。

#### 契機

- イベントの発生
- イベントの結果

#### 保持期間

１年以上保持（PCI DSS 要件）

#### 留意事項

- レベル **ERROR** のログは通知対象となる。サービス影響のある事象に出力を限定すること。
- カード番号 / 有効期限は**マスクして出力**すること。（PCI DSS 要件）

---

## 3. Routing Engine

### 3.1 電文受信

業務アプリ（AP02/AP22）からの TCP 接続を受け付ける。

| 項目 | 仕様 |
|------|------|
| プロトコル | TCP |
| 待ち受けポート | 7000（CAFIS系）、5000（CARDNET系） |
| 電文フォーマット | ヘッダ（コンテンツ長 + CRLF）+ ボディ（Key=Value、CRLF区切り） |

:::note
現行 AP03 のヘッダは 5バイト（10進数）+ CRLF、AP02 の CafisCC は 7バイト + CRLF。
統一仕様は詳細設計で決定する。
:::

### 3.2 電文解析・仕向け先判定

| 機能 | 内容 |
|------|------|
| 電文解析 | 電文ヘッダから仕向け先を判定 |
| ルーティング | ルーティングテーブルに基づき Gateway Service を選択 |

### 3.3 フェイルオーバー

| 機能 | 内容 |
|------|------|
| Gateway 障害検知 | Gateway Service のヘルスチェック |
| 自動切替 | 障害時に同一回線の別 Gateway へ振り分け |

### 3.4 スレッド管理

| 機能 | 内容 |
|------|------|
| リクエストスレッドプール | 同時処理数の制御（現行 AP03: 5スレッド） |
| 処理中カウント | 業務処理中トランザクション数の管理 |
| グレースフルシャットダウン | 停止前に処理中トランザクションの完了を待機（現行 AP03: 最大60秒） |

---

## 4. Gateway Service（共通）

Gateway Service は回線ごとに配置し、CAFIS 用と CARDNET 用で共通のアーキテクチャを持つ。

### 4.1 接続管理

| 機能 | 内容 |
|------|------|
| 常時 Listen | CAFIS/CARDNET からの接続を受け付ける（自社がサーバー側） |
| 接続状態管理 | 状態マシン（DISCONNECTED → CONNECTING → CONNECTED → DISCONNECTING → ERROR） |
| 排他制御 | 開局/閉局時に業務処理との同時実行を防止 |

### 4.2 セッション管理

| 機能 | 内容 |
|------|------|
| セッションプール | 複数セッションの保持・管理 |
| 自動再生成 | セッション障害時に全セッションを閉じて再オープン |
| セッション枯渇対応 | セッション ID 不足時の再構築 |

:::info
現行 AP03 はセッション管理を FEXICS の JNI API 経由で行っている。
新システムでは Gateway Service 自体がセッションを管理する。
:::

### 4.3 電文変換

| 機能 | 内容 |
|------|------|
| リクエスト変換 | 業務アプリ形式 → CAFIS/CARDNET 電文形式 |
| レスポンス変換 | CAFIS/CARDNET 電文形式 → 業務アプリ形式 |
| レスポンス解析 | 応答電文のエラーコード検証、確認番号チェック |

### 4.4 障害対応

| 機能 | 内容 |
|------|------|
| 障害取消の自動送信 | 送信成功後にエラーが発生した場合、自動的に SystemCancel を送信（金融整合性の保証） |
| A1/A2系切替 | 回線系切替 |
| タイムアウト制御 | 応答待ちタイムアウト（現行: 90秒） |
| リトライ | 通信エラー時の再試行 |
| リカバリ | 接続断時の自動再接続シーケンス |

### 4.5 監視

| 機能 | 内容 |
|------|------|
| 接続先状態監視 | CAFIS/CARDNET 側の状態変化を検知（現行 AP03 の DaemonEventChkThread に相当） |
| ヘルスチェック応答 | Routing Engine / 外部監視からの死活確認に応答 |

---

## 5. Gateway Service（CAFIS）

### 5.1 対応コマンド

ソースコード調査（AP02 + AP03）に基づく CAFIS 向けコマンド一覧。

#### 決済処理

| コマンド | 機能 | 備考 |
|----------|------|------|
| B01 | iD アクセスキー取得 | iD 決済で使用 |
| B11 | iD オンラインオーソリ | |
| B12 | iD オーソリ取消 | |
| B16 | MS（磁気）オンラインオーソリ | |
| B17 | MS オーソリ取消 | |
| B22 | IC オンラインオーソリ | SecureIC、Global Action からも利用 |
| B23 | IC オーソリ取消 | SecureIC、Global Action からも利用 |
| B24 | アドバイス（取引確定） | IC / SecureIC で使用 |
| B25 | 障害取消 | 障害時の取引復旧 |

#### システム制御

| コマンド | 機能 | 備考 |
|----------|------|------|
| C01 | 開局（接続確立） | |
| C02 | 閉局（接続切断） | |
| C03 | ステータス取得 | ヘルスチェックにも使用 |
| C11 | 締め日取得 | 日次更新 |
| C12 | 締め日更新 | 日次更新 |

#### 対象外

| コマンド | 機能 | 理由 |
|----------|------|------|
| B20, B21 | 銀聯オーソリ / 取消 | ほぼ未使用のため対象外 |
| B30〜B33 | 売上オーソリ系 | 未使用のため対象外 |

### 5.2 接続仕様

| 項目 | 仕様 |
|------|------|
| 接続先 | CAFIS（NTTDATA） |
| 外部向けポート | 2010 |
| 接続方向 | CAFIS から接続を受ける（自社が Listen） |
| 接続コード | 2s30809-000x |

---

## 6. Gateway Service（CARDNET）

### 6.1 対応コマンド

ソースコード調査（AP22）に基づく CARDNET 向けコマンド一覧。

#### 決済処理

| コマンド | 機能 | 備考 |
|----------|------|------|
| OnlineAuthICC | IC オンラインオーソリ | CAFIS の B22 相当 |
| OnlineAuthICC_Cancel | IC オーソリ取消 | CAFIS の B23 相当 |
| SystemCancel | 障害取消 | CAFIS の B25 相当 |

#### システム制御

| コマンド | 機能 | 備考 |
|----------|------|------|
| SignOn | 開局 | CAFIS の C01 相当 |
| SignOff | 閉局 | CAFIS の C02 相当 |
| GetStatus | ステータス取得 | CAFIS の C03 相当 |
| CutOver | 日次更新 | CAFIS の C12 相当 |
| Echo | 死活確認（ハートビート） | CAFIS 側には対応なし |

### 6.2 接続仕様

| 項目 | 仕様 |
|------|------|
| 接続先 | CARDNET（JCN） |
| 外部向けポート | 2200 |
| 接続方向 | CARDNET から接続を受ける（自社が Listen） |
| 接続コード | 3M308090001 |

### 6.3 固有処理

| 処理 | 内容 |
|------|------|
| Saison カード対応 | ICC データの 9F02 タグゼロ設定、9F5A タグ除去 |
| AMEX テスト対応 | テスト環境での ORG_CODE_CARDNET 送信 |
| BIT62 データ解析 | JCB / Saison のカスタムレスポンス解析 |
| カード有効性キャッシュ | 14日間のカード有効性結果キャッシュ |
| モード切替 | TEST / PRODUCTION の動的切替 |

---

## 7. 業務アプリ側の変更

### 7.1 AP02（CAFIS業務処理サービス）

| 項目 | 現行 | 変更後 |
|------|------|--------|
| 接続先 | AP03 (TCP:7000) | Routing Engine (TCP:7000) |
| 変更内容 | 接続先の設定変更 | ポート番号維持のため設定変更のみ |

### 7.2 AP22（CARDNET業務サービス）

| 項目 | 現行 | 変更後 |
|------|------|--------|
| 接続先 | FEXICS (DLL直接呼出し) | Routing Engine (TCP:5000) |
| 変更内容 | FexicsAPI_CN パッケージの利用 | TCP クライアントへの置き換え |

:::caution
AP22 は現行で FEXICS DLL を直接呼び出しているため、AP02 と比べて**変更範囲が大きい**。
FexicsServiceRepository の IFexicsServiceRepository インターフェースを維持しつつ、
内部実装を TCP 通信に置き換える方針とする。
:::
