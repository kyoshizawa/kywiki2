# 機能要件

## 改訂履歴

| バージョン | 日付       | 改定内容 | 改定者 |
| ---------- | ---------- | -------- | ------ |
| v0.1       | 2026-02-03 | 初版作成 | k_yoshizawa |
| v0.2       | 2026-02-19 | インフラレビュー結果反映、記載の整理 | k_yoshizawa |

---

## 概要

本章では、FEXICS代替として新規開発および変更が必要なコンポ－ネントの機能要件を定義する。
機能の洗い出しは、既存コンポーネント（AP02, AP03, AP22）のソースコード調査結果に基づく。

新規作成コンポーネントの共通事項については、別途以下にまとめる。

[共通事項](./04-functions_01_part1_common.md)

#### INDEX

- 機能要件： Routing Engine
- 機能要件： Gateway Service
- 機能要件： Cli
- 機能要件： Dummy Center
- 機能要件： 更新対象のソフト

## 1. 機能要件： Routing Engine

#### 分類

- 新規構築

#### 役割

- 電文解析、接続コードによる Gateway Service への中継
- Gateway Service 障害時のフォールバック
- 電文処理の負荷分散（スケーリング）

#### 実行環境

- Amazon ECS (Fargate)

#### 待ち受けPort 

-  7000（CAFIS系）, 5000（CARDNET系）

#### 利用プロトコル

-  gRPC 

※ クライアントからはSSL接続されるが、ALBでオフロードするため、
   アプリケーションは暗号無しの gRPC として処理すればよい。

#### DB通信

- 本ソフトは DB接続を利用しない

### 1.1  機能：電文中継

- Routing Engine は クライアントとなる `AP02`, `AP22` からの電文を受け、
  データを指定された接続コードの　Gateway Service に転送する。

- Routing Engine は 接続コード = 接続先の変換表を設定として持ち、
  対応するサーバへの接続を試行する。

- 候補となる Gateway が複数ある場合、クライアントから複数の接続コードを指定する。※ その際はいずれかのサーバへ接続される。

  [実行イメージ]

  ![1-1](./img/functions-1-1.png)

- CAFIS 用のポートで受けた場合、CAFIS の変換表から  
  CARDNET 用のポートで受けた場合、CARDNET の変換表から  
  接続先を決定する。

  **変換表サンプル**

    | 接続コード | 接続先 | 種別 |
    | --- | --- | --- |
    | 2s30809-0003 | 192.1.1.1:7000 | CAFIS |
    | 2s30809-0004 | 192.1.1.2:7000 | CAFIS |
    | 3M30809-0003 | 192.1.1.1:5000 | CARDNET |
    | 3M30809-0004 | 192.1.1.2:5000 | CARDNET |

    ※ IPアドレスは実際のものとは異なります。

- 変換表は環境変数からの設定とする。


### 1.2  機能：障害時のフォールバック

- Routing Engine は Gateway Service の生存監視機能を持つ。  
  生存監視はバックグラウンドで `設定` 秒ごとに行われる。

- クライアントから指定された接続コードのうち、現在障害中の接続先を避けて  
  電文中継を実行する。

- 指定されたすべての接続コードが利用できない場合、エラー応答とする。

### 1.3  機能：ヘルスチェック応答

- Routing Engine は自身が処理可能な間、 ALB からのヘルスチェックに応答する必要がある。

---
## 2. 機能要件： Gateway Service

#### 分類

- 新規構築

#### 役割

- CAFIS, CARDNET への接続
- クライアントの電文を CAFIS, CARDNET 形式に変換する 

#### 実行環境

- Amazon EC2 (Windows)

#### 待ち受けPort 

**カード会社側からの待ち受け**
-  2010（CAFIS系）※ 開発環境では 2009
-  2200（CARDNET系）

**routing engine側からの待ち受け**
-  7000（CAFIS系）, 5000（CARDNET系）

#### 利用プロトコル

-  gRPC (SSL)

※ ALB を挟まないため、アプリケーションが証明書処理を行う。  
※ 証明書管理が必要。

#### DB通信

- ジャーナル保存のため SecureDB の通信を行う。

### 2.1  機能：CAFIS/CARDNET電文処理

- Gateway Service は CAFIS/CARDNET の電文を解析し、適切なシーケンス処理および 
  Routing Engine との電文変換処理を行う。
  
- CAFIS/CARDNETの詳細仕様についてはここには記載しない。  
  別途、関連資料を参照すること。

- CAFIS / CARDNET のどちらの接続として振舞うかは、起動時の設定確認で決定する。

  [実行イメージ]

  ![2-1](./img/functions-2-1.png)


### 2.2  機能：既存互換の電文サポート




### 2.x  機能：ヘルスチェック応答

- Gateway Service は自身が処理可能な間、Routing Engine からのヘルスチェックに応答する必要がある。
- [処理可能な間] は CAFIS / CARDNET への疎通状態も含まれる。  
  これらが確認できない場合、ヘルスチェック = NG とならなければいけない。









## 3. 機能要件： Cli


## 4. 機能要件： Dummy Center


## 5. 機能要件： 更新対象のソフト


### 業務アプリ側の変更

| アプリ | 変更内容 |
|--------|---------|
| AP02 CAFIS業務処理サービス | 接続先を AP03→Routing Engine(Port 7000) に変更 |
| AP22 CARDNET業務サービス | 接続先を FEXICS→Routing Engine(Port 5000) に変更 |

