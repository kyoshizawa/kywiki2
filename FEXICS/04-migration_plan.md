# 移行計画

## 改訂履歴

| バージョン | 日付       | 改定内容 | 改定者 |
| ---------- | ---------- | -------- | ------ |
| v0.1       | 2026-02-05 | 初版作成 | k_yoshizawa |

---

## 1. 移行計画 概略

本計画は、本番稼働中の Act-Act 構成サーバに影響を与えることなく  
FEXICS 新実装のフィールド導入を行うことを目的とする。

そのため、既存の本番環境とは独立した新規サーバ環境を構築し、  
あわせて専用回線の新規敷設を行う方針とする。

本構成は、「専用線接続の切替」に伴うリスクを低減することを目的とした対策である。

## 2. ロードマップ（STEP1）

### CAFIS

| フェーズ | 内容 |
| ------ | ---- |
| 開発期間中 | 新規回線契約 |
|           | インフラ環境構築 |
|           | ブランド試験用環境（新規環境）に接続し、開発中の検証を実施 |
| 実装完了   | 認定試験： CAFIS 伝送試験 |
|           | 認定試験： CAFIS 機能試験 |
| リリース   | 本番環境リリース |
|           | 認定試験： CAFIS 総合確認試験 |
| 顧客導入   | 顧客単位で新環境に接続する設定（新規ユーザ）|
|           | 顧客単位で新環境に接続する設定（既存ユーザ）|
| 全顧客切替完了   | 問題ないと判断できた場合、既存回線の解約およびサーバ撤去を実施 |

> **Note**  
> CAFIS のブランド試験環境は、特段の対外調整を行うことなく試験可能である（AMEX のみアクワイヤラまで自動疎通している）。

### CARDNET

| フェーズ | 内容 |
| ------ | ---- |
| 開発期間中 | 新規回線契約 |
|           | インフラ環境構築 |
|           | ブランド試験用環境（新規環境）に接続し、開発中の検証を実施 |
| 実装完了   | 認定試験： CARDNET 伝送試験 |
|           | 認定試験： CARDNET 機能試験 |
| リリース   | 本番環境リリース |
|           | 認定試験： CARDNET 総合確認試験 |
| 顧客導入   | 顧客単位で新環境に接続する設定（新規ユーザ）|
|           | 顧客単位で新環境に接続する設定（既存ユーザ）|
| 全顧客切替完了   | 問題ないと判断できた場合、既存回線の解約およびサーバ撤去を実施 |

> **Note**  
> CARDNET のブランド試験環境は、利用時、事前予約が必要。

## 3. 回線契約

現行の回線契約状況と、追加する想定の契約。

**CAFIS**

| 区分 | 契約コード | 環境 |
|---|---|---|
| 現行 | 2s30809-0001 | 本番 |
| 現行 | 2s30809-0002 | 本番 |
| 現行 | 2s30809-0002' | 解放試験 |
| `新規` | 2s30809-0003 | 本番 |
| `新規` | 2s30809-0004 | 本番 |
| `新規` | 2s30809-0005 | 解放試験 |

**CARDNET**

| 区分 | 契約コード | 環境 |
|---|---|---|
| 現行 | 3M30809-0001 | 本番 |
| 現行 | 3M30809-0002 | 本番 |
| 現行 | 3M30809-0002' | 解放試験 |
| `新規` | 3M30809-0003 | 本番 |
| `新規` | 3M30809-0004 | 本番 |
| `新規` | 3M30809-0005 | 解放試験 |

> **Note**  
> 解放試験用の契約コードは、既存コードと混同しないよう別コードとしている。

## 4. 移行イメージ

### 4.1 全体像

既存本番環境（現行サーバ + 現行回線）を稼働させたまま、
新規サーバ + 新規回線を独立して構築し、顧客単位で段階的に切り替える。

```
                        ┌─────────────────────────────────┐
                        │        決済端末群                │
                        └────────────┬────────────────────┘
                                     │
                        ┌────────────▼────────────────────┐
                        │     AP01 / AP11                  │
                        │  （顧客ごとの振り分け設定）      │
                        └───┬─────────────────────┬───────┘
                            │                     │
               顧客A,B,C → │      　　顧客D,E → │
                            ▼                     ▼
              ┌──────────────────┐   ┌──────────────────┐
              │  現行環境         │   │  新環境           │
              │  Server 1号機     │   │  新規サーバ       │
              │  Server 2号機     │   │  (ECS on EC2)     │
              │  ┌────────────┐  │   │  ┌────────────┐  │
              │  │ FEXICS     │  │   │  │ Routing    │  │
              │  │ + AP03     │  │   │  │ Engine     │  │
              │  └─────┬──────┘  │   │  └─────┬──────┘  │
              │        │         │   │        │         │
              │  ┌─────▼──────┐  │   │  ┌─────▼──────┐  │
              │  │ 現行回線    │  │   │  │ Gateway    │  │
              │  │ 0001,0002  │  │   │  │ Service    │  │
              │  └─────┬──────┘  │   │  └─────┬──────┘  │
              └────────│─────────┘   └────────│─────────┘
                       │                      │
              ┌────────▼──────┐   ┌───────────▼─────┐
              │ 現行回線       │   │ 新規回線         │
              │ 0001, 0002    │   │ 0003, 0004      │
              └────────┬──────┘   └───────────┬─────┘
                       │                      │
              ┌────────▼──────────────────────▼─────┐
              │        CAFIS / CARDNET               │
              └─────────────────────────────────────┘
```

### 4.2 移行フェーズ

#### Phase A: 並行環境構築（開発期間中）

新規回線の契約・敷設と、新規サーバ環境の構築を行う。
この時点では本番トラフィックは流さず、ブランド試験環境での開発検証のみ。

```
  現行環境（本番稼働中）          新環境（構築中）
  ┌────────────────┐            ┌────────────────┐
  │ FEXICS + AP03  │            │ Routing Engine │
  │ 全顧客が利用   │            │ + Gateway      │
  │                │            │                │
  │ 回線: 0001,02  │            │ 回線: 0005     │
  │ (本番)         │            │ (試験用)       │
  └────────────────┘            └────────────────┘
         │                             │
    ┌────▼────┐                  ┌─────▼─────┐
    │ CAFIS   │                  │ CAFIS     │
    │ CARDNET │                  │ ブランド   │
    │ (本番)  │                  │ 試験環境  │
    └─────────┘                  └───────────┘
```

- 現行環境への影響: **なし**
- 新規回線 0003, 0004 は敷設のみ（本番接続は Phase C 以降）

#### Phase B: 認定試験（実装完了後）

新環境で CAFIS / CARDNET の認定試験（伝送試験・機能試験）を実施する。
試験用回線（0005）を使用。本番環境は引き続き全顧客が利用。

#### Phase C: 本番リリース・新規顧客導入

新規回線（0003, 0004）を本番接続し、新環境を本番稼働させる。
まず**新規顧客**を新環境に向ける。

```
  AP01 / AP11 の振り分け設定:
  ┌────────────────────────────────────────┐
  │ 顧客A（既存） → 現行環境              │
  │ 顧客B（既存） → 現行環境              │
  │ 顧客C（既存） → 現行環境              │
  │ 顧客D（新規） → ★ 新環境             │
  └────────────────────────────────────────┘
```

- 新規顧客で問題がないことを確認
- 総合確認試験の実施

#### Phase D: 既存顧客の段階的切替

既存顧客を1社ずつ新環境に切り替える。
切替は AP01 / AP11 の設定変更により行う。

```
  段階 1:  顧客A → 新環境に切替　（他は現行環境のまま）
  段階 2:  顧客B → 新環境に切替　（問題なければ次へ）
  段階 3:  顧客C → 新環境に切替
  ...
  段階 N:  全顧客の切替完了
```

- 切替単位: **顧客ごと**
- 切替方法: AP01 / AP11 の接続先設定変更
- 切替タイミング: 取引の閑散時間帯（深夜等）を推奨
- 切替間隔: 1社切替後、一定期間（1週間程度）の安定稼働を確認してから次の顧客へ

#### Phase E: 現行環境の撤去

全顧客の切替完了後、一定の安定稼働期間を経て現行環境を撤去する。

| 作業 | 内容 |
|------|------|
| 現行回線の解約 | 0001, 0002 の解約手続き |
| 現行サーバの撤去 | FEXICS + AP03 サーバの停止・撤去 |
| 試験用回線の扱い | 0005 は開発・試験用として継続保持を推奨 |

### 4.3 切替時の運用

#### 切替手順（1顧客あたり）

| 手順 | 作業 | 備考 |
|------|------|------|
| 1 | 対象顧客の取引状況を確認 | 処理中トランザクションがないことを確認 |
| 2 | AP01 / AP11 の振り分け設定を変更 | 対象顧客の接続先を新環境に変更 |
| 3 | 疎通確認 | 新環境経由での取引成功を確認 |
| 4 | 監視強化期間 | 切替後24時間はアラート閾値を引き下げ |

#### 切り戻し手順

問題発生時は AP01 / AP11 の設定を現行環境に戻すことで即時切り戻しが可能。

| 手順 | 作業 |
|------|------|
| 1 | 障害検知・切り戻し判断 |
| 2 | AP01 / AP11 の振り分け設定を現行環境に変更 |
| 3 | 現行環境での取引正常性を確認 |
| 4 | 原因調査・対策後に再切替を計画 |

> **Note**
> 現行環境は全顧客の切替完了まで稼働を継続するため、
> いつでも切り戻しが可能な状態を維持する。

### 4.4 切替判断基準

#### 次の顧客に進む基準

| 項目 | 基準 |
|------|------|
| エラー率 | 現行環境と同等以下 |
| レスポンスタイム | 500ms 以下（現行同等） |
| 安定稼働期間 | 切替後 1週間以上の正常稼働 |

#### 切り戻し判断基準

| 項目 | 基準 |
|------|------|
| 決済エラー | 新環境固有のエラーが発生 |
| レスポンス劣化 | 既存比で顕著な遅延 |
| 接続断 | CAFIS / CARDNET との接続維持不能 |

