# ISO8583

本文書は CAFIS/CARDNET 電文に関連する `ISO8583` の参考文書です。

## 定義

- ISO8583は以下を一切規定していません：

    TCP/UDP の使用有無  
    ヘッダ構造  
    電文長の表現方法  
    通信プロトコル  
    再送方式  
    セッション管理  

    つまり：
    ISO8583は通信プロトコルではない

    OSIモデルで見ると：  
    アプリケーション層 ← ISO8583はここだけ  
    ────────────────
    トランスポート層 ← TCP
    ネットワーク層

    つまり：
    ISO8583は「データフォーマット規格」です。


## メッセージ構造

電文構造：

```
MTI | Bitmap | Data Elements
```

### 電文種別（MTI）

データサイズ： 4文字（バイト数の規定は ISO8583 にはない）  

メッセージの種類を4桁で表す。  

代表的な例：

| MTI | 意味 | 例 |
|---|---|---|
| 0100 | オーソリ要求 | カード会員が購入するための端末からの承認要求 |
| 0110 | オーソリ応答 | カード会員へ承認するためのイシュアからPOS端末への応答 |
| 0120 | オーソリアドバイス |  |

### Bitmap（存在フラグ）

データサイズ： 基本8バイト  

どのフィールドが含まれているかを示すビット列

例：

```
723A000108A08012
```

bit2 = 1	： データエレメント2あり  

などのように解釈する。  
これがないと電文解析できない  

Secondary Bitmap が存在することがある。  
その場合は 16 バイトになる。  

Secondary Bitmap ありは bit1 で表現される。

```
(Primary Bitmap の) bit1 = 1 なら Secondary Bitmapあり
```

この bit1 に対応する Data Elements は例外的に存在しない。

### Data Elements（実データ）

データサイズ：可変長 （含まれるフィールド定義による） 

ここに実際の値が並ぶ。

例：

```
DE2 = 4111111111111111
DE3 = 000000
DE4 = 000000010000
DE11 = 123456
```

#### フィールド定義

各データ項目に番号が付いている：

| 番号 | 意味 |
|---|---|
| 2	| カード番号 |

など。

データ項目ごとに 

| 型      | 説明     |
| ------ | ------ |
| 固定長    | 長さ固定   |
| LLVAR  | 2桁長さ付き |
| LLLVAR | 3桁長さ付き |

が決まる。

## CAFISとの関係

「ISO8583ではない」

CAFISの通信仕様は `ISO8583をベースにした独自プロトコル` です。

ただ、CAFISは ISO8583に変換して通信を行うはず。  
そのため、ブランドの問い合わせでは ISO8583 の BIT項番で話をされることがある。  

## CARDNETとの関係

CARDNETの通信仕様はISO8583寄り。

実際：Bitmapあり、DE番号概念あり。

