## 考慮メモ


### 暗号化


### 実装したい機能のメモ
- 顧客単位での切り替え
- AP22 が FEXICS 直利用のため、クライアントコードをかませる必要ある。   
  それなら AP02 もクライアントコードを入れ替えてもいいかも。  

- シミュレータ機能（開発環境）

- ジャーナル確認できる機能
- 性能状況の観測ができる機能

### DBもつなら
- PCI 要件での暗号化保存

### 他
- ログ収集はインフラと確認

### ロードマップ
[CAFIS]
- 開発サーバ置き換え
- ブランド試験サーバ確認
- 本番リリース

[CARDNET]
- 〃



## claude 提案 考慮事項

  可用性・障害対策                                                                                                                                      
  - フェイルオーバー戦略 - Active-Active 2台構成でのセッション引き継ぎ方法                                                                           
  - ヘルスチェック - CAFIS/CARDNET 側からの死活監視への応答
  - タイムアウト設計 - 各処理段階でのタイムアウト値と挙動
  - リトライ戦略 - 通信エラー時の再試行ポリシー
  - サーキットブレーカー - 連続障害時の縮退運転

  セキュリティ（PCI DSS 関連）

  - 通信暗号化 - TLS バージョン、証明書管理
  - 監査ログ - アクセス記録、改ざん検知
  - 鍵管理 - 暗号鍵のローテーション、保管方法
  - ネットワーク分離 - セグメント設計

  運用

  - 設定管理 - 環境別設定の切り替え方法
  - デプロイ戦略 - 無停止デプロイの方法
  - ロールバック手順 - 切り戻し方法と判断基準
  - 監視・アラート - 閾値設定、通知先

  パフォーマンス要件

  - スループット - 秒間トランザクション数の目標値
  - レイテンシ - 許容応答時間
  - コネクション管理 - プーリング、最大接続数

  テスト

  - 結合テスト環境 - CAFIS/CARDNET との接続試験方法
  - 負荷テスト - ピーク時想定の検証方法
  - 障害注入テスト - 異常系の検証

  移行時の整合性

  - トランザクション整合性 - 切り替え時の処理中電文の扱い
  - 切り戻し判断基準 - どの指標で判断するか

  これらの中で優先度が高いもの、または深掘りしたい項目はありますか？


## 2026/02/03 MTG メモ 
- プラチナ２が終わる
  新しいコンポーネントでは乗せ換えるか。

- インスタンスが Gateway AP03 から DB に書き込んでるので注意。
  → これはやっていない。

- STEP2 のやり方
  回線は MC の使い、これの上を別パートナーの電文を通す

- 図で 3 4 増やすときの案を整理
  
- 今の pay_pf_doc を変える




# 課題：

- 電文のイメージができていない。これは受け入れ時に困る。

- routing service はどちらを通っても取引の前状態がわかる（＝障害取消ができる）ようにしたい。

- 停止時、閉局操作がいる（イベントを拾えるか）


## 2026/02/16 調査：CAFIS 障害電文（取消系）の整理

出典: CAFIS_03_BasicConnect / 01_CAFIS_Basic_03_ConnectSpec.md（表 3.1-3〜3.1-6, 表 3.3.2-1）

### 障害電文の種類（すべて加盟店センター（仕向側）→ CAFIS へ送信）

| 電文種別コード | 電文名 |
|---|---|
| 8910 | 取消指令 |
| 8920 | 取消再指令 |
| 8930 | 取消確認指令 |
| 8940 | 取消確認再指令 |

### 送信条件

| 状況 | 送信する電文 |
|---|---|
| CAFISから報告を受信したが、クライアント（端末）側に返せなかった | 取消指令 |
| 取消指令の応答がCAFISから来なかった（タイムアウト） | 取消再指令 |
| 要求を送信したがCAFISから応答がなかった（タイムアウト） | 取消確認指令 |
| 取消確認指令の応答がCAFISから来なかった（タイムアウト） | 取消確認再指令 |

### 応答電文（CAFIS → 加盟店センター）

| 電文種別コード | 電文名 | 対応する指令 |
|---|---|---|
| 8950 | 取消報告 | 取消指令/取消再指令への応答 |
| 8960 | 取消確認報告 | 取消確認指令/取消確認再指令への応答 |
| — | 異常報告 | 指令の電文自体にエラーがあった場合の応答 |

### 応答電文に含まれるエラーコード（表 3.3.5-2）

| エラーコード | 事象 | CAFIS応答電文 |
|---|---|---|
| C13 | 被仕向センタ障害中 | 取消報告 or 取消確認報告 |
| C14 | 被仕向センタ個別終了 | 取消報告 or 取消確認報告 |
| C50 | タイムアウト（被仕向からの報告待ち） | 取消報告 or 取消確認報告 |
| C01, C03, C12, C15, C33 等 | その他のエラー（会社コード不正、電文長超過等） | 異常報告 |

### フロー（2系統）

```
【系統1: CAFISから応答が来なかった場合】
要求 →(timeout)→ 取消確認指令 → 取消確認報告(8960)が返る ※正常
                              →(timeout)→ 取消確認再指令 → ...

【系統2: 報告は受信したがクライアントに返せなかった場合】
取消指令 → 取消報告(8950)が返る ※正常
        →(timeout)→ 取消再指令 → ...
```

### 補足
- 経路保留: 取消確認（再）指令は元の要求と同一経路で送信する。取消指令は取消確認と同一経路で送信する。
- CAFIS折返しの要求電文の場合は障害電文を送信しない。

