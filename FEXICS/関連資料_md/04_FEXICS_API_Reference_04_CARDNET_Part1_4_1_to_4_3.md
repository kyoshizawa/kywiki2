# 第4章 CARDNET 接続のプログラミング要素（Part1：4.1〜4.3）

この章では、CARDNET 接続サービスを使用する上で重要となる  
**基本的なプログラミング要素**について説明する。

CARDNET 接続サービスでは、**通番**を通してトランザクションの唯一性を確保する。  
また、取引タイプおよびアプリケーションタイプの指定により、  
**電文フォーマットは自動的に選択**される。

---

## 4.1. 通番

一連の取引電文に割り振られた番号（ID）を **通番** と呼ぶ。  
要求電文とそれに対応する応答電文は、**同一の通番**を所有する。

- 作成／送信した電文と、その応答電文は同じ通番を持つ
- オーソリ取得と、その後のキャプチャ電文は **異なる通番** となる

### 通番取得に使用される API

| API | 用途 |
|---|---|
| FX_SendAuth() | 仕向業務 Dual Message 処理 |
| FX_SendAndCaptureAuth() | 仕向業務 Single Message 処理 |
| FX_GetSeqNum() | 通番取得 |
| FX_ReceiveMsg_CN() | 電文受信 |

### 通番の仕様

- 型：32ビット符号なし整数
- 値域：`1 ～ 999999`
- 動作：
  - 新しい通番取得ごとにインクリメント
  - `999999` の次は `1` に戻る

---

## 4.2. 業務電文域（fx_XMsg）

FEXICS では、**業務電文域**を  
`fx_XMsg` ポインタで指定されるメモリエリアに格納して操作する。

### 業務電文域の管理

- メモリの割り当て／解放は **アプリケーション側の責任**
- 電文情報の定義は以下のヘッダファイルに記載されている

```text
fxapi.h
```

---

## 4.3. 取引の識別

CARDNET 接続サービスでは、  
**取引の識別**を以下の組み合わせで行う。

- トランザクションタイプ
- アプリケーションタイプ

これにより、取引内容に応じた電文フォーマットが自動選択される。

---

### 4.3.1. トランザクションタイプ（取引系電文）

トランザクションタイプとは、各クレジット決済センターの手順ビットマップ・パターンと一対一に対応した業務の取引の種類を特定する識別子です。  
トランザクションタイプの定義は、ヘッダーファイル `fxapi.h` に定義されています。

#### オーソリ / 残高照会 / ARQCオーソリ
| トランザクションタイプ | 電文種別 | 取引タイプ | 入力モード | PIN | 拡張ビット |
|---|---|---|---|---|---|
| TRN_AUTTN | C100/C110 | ショッピング オーソリ | TRACK2(JIS1) | なし |  |
| TRN_AUTJN | C100/C110 | ショッピング オーソリ | JIS2 | なし |  |
| TRN_AUTMN | C100/C110 | ショッピング オーソリ | Manual | なし |  |
| TRN_AUTTP | C100/C110 | ショッピング オーソリ | TRACK2(JIS1) | あり |  |
| TRN_AUTJP | C100/C110 | ショッピング オーソリ | JIS2 | あり |  |
| TRN_AUTMP | C100/C110 | ショッピング オーソリ | Manual | あり |  |
| TRN_AUTTN62 | C100/C110 | ショッピング オーソリ | TRACK2(JIS1) | なし | 62 |
| TRN_AUTJN62 | C100/C110 | ショッピング オーソリ | JIS2 | なし | 62 |
| TRN_AUTMN62 | C100/C110 | ショッピング オーソリ | Manual | なし | 62 |
| TRN_AUTTP62 | C100/C110 | ショッピング オーソリ | TRACK2(JIS1) | あり | 62 |
| TRN_AUTJP62 | C100/C110 | ショッピング オーソリ | JIS2 | あり | 62 |
| TRN_AUTMP62 | C100/C110 | ショッピング オーソリ | Manual | あり | 62 |
| TRN_AUTTN63 | C100/C110 | ショッピング オーソリ | TRACK2(JIS1) | なし | 63 |
| TRN_AUTJN63 | C100/C110 | ショッピング オーソリ | JIS2 | なし | 63 |
| TRN_AUTMN63 | C100/C110 | ショッピング オーソリ | Manual | なし | 63 |
| TRN_AUTTP63 | C100/C110 | ショッピング オーソリ | TRACK2(JIS1) | あり | 63 |
| TRN_AUTJP63 | C100/C110 | ショッピング オーソリ | JIS2 | あり | 63 |
| TRN_AUTMP63 | C100/C110 | ショッピング オーソリ | Manual | あり | 63 |
| TRN_AUTTN6263 | C100/C110 | ショッピング オーソリ | TRACK2(JIS1) | なし | 62&63 |
| TRN_AUTJN6263 | C100/C110 | ショッピング オーソリ | JIS2 | なし | 62&63 |
| TRN_AUTMN6263 | C100/C110 | ショッピング オーソリ | Manual | なし | 62&63 |
| TRN_AUTTP6263 | C100/C110 | ショッピング オーソリ | TRACK2(JIS1) | あり | 62&63 |
| TRN_AUTJP6263 | C100/C110 | ショッピング オーソリ | JIS2 | あり | 62&63 |
| TRN_AUTMP6263 | C100/C110 | ショッピング オーソリ | Manual | あり | 62&63 |
| TRN_INQD | D100/D110 | デビットカード残高照会 | TRACK2(JIS1) | あり |  |
| TRN_INQJD | D100/D110 | J-DEBIT残高照会 | JIS2 | あり |  |
| TRN_INQD62 | D100/D110 | デビットカード残高照会 | TRACK2(JIS1) | あり | 62 |
| TRN_INQJD62 | D100/D110 | J-DEBIT残高照会 | JIS2 | あり | 62 |
| TRN_ARQC_AUTIN | Q100/Q110 | IC ARQC オーソリ | JIS1 IC | なし |  |
| TRN_ARQC_AUTI2N | Q100/Q110 | IC ARQC オーソリ | JIS2 IC | なし |  |
| TRN_ARQC_AUTIP | Q100/Q110 | IC ARQC オーソリ | JIS1 IC | あり |  |
| TRN_ARQC_AUTI2P | Q100/Q110 | IC ARQC オーソリ | JIS2 IC | あり |  |
| TRN_ARQC_AUTIN62 | Q100/Q110 | IC ARQC オーソリ | JIS1 IC | なし | 62 |
| TRN_ARQC_AUTI2N62 | Q100/Q110 | IC ARQC オーソリ | JIS2 IC | なし | 62 |
| TRN_ARQC_AUTIP62 | Q100/Q110 | IC ARQC オーソリ | JIS1 IC | あり | 62 |
| TRN_ARQC_AUTI2P62 | Q100/Q110 | IC ARQC オーソリ | JIS2 IC | Ⓡ あり | 62 |
| TRN_ARQC_AUTIN63 | Q100/Q110 | IC ARQC オーソリ | JIS1 IC | なし | 63 |
| TRN_ARQC_AUTI2N63 | Q100/Q110 | IC ARQC オーソリ | JIS2 IC | なし | 63 |
| TRN_ARQC_AUTIP63 | Q100/Q110 | IC ARQC オーソリ | JIS1 IC | あり | 63 |
| TRN_ARQC_AUTI2P63 | Q100/Q110 | IC ARQC オーソリ | JIS2 IC | あり | 63 |
| TRN_ARQC_AUTIN6263 | Q100/Q110 | IC ARQC オーソリ | JIS1 IC | なし | 62&63 |
| TRN_ARQC_AUTI2N6263 | Q100/Q110 | IC ARQC オーソリ | JIS2 IC | なし | 62&63 |
| TRN_ARQC_AUTIP6263 | Q100/Q110 | IC ARQC オーソリ | JIS1 IC | あり | 62&63 |
| TRN_ARQC_AUTI2P6263 | Q100/Q110 | IC ARQC オーソリ | JIS2 IC | あり | 62&63 |

#### オーソリアドバイス
| トランザクションタイプ | 電文種別 | 取引タイプ | 入力モード | PIN | 拡張ビット |
|---|---|---|---|---|---|
| TRN_AADT | C120･C121/C130 | オーソリアドバイス | TRACK2(JIS1) |  |  |
| TRN_AADJ | C120･C121/C130 | オーソリアドバイス | JIS2 |  |  |
| TRN_AADI | C120･C121/C130 | オーソリアドバイス | JIS1 IC |  |  |
| TRN_AADI2 | C120･C121/C130 | オーソリアドバイス | JIS2 IC |  |  |
| TRN_AADM | C120･C121/C130 | オーソリアドバイス | Manual |  |  |
| TRN_AADT62 | C120･C121/C130 | オーソリアドバイス | TRACK2(JIS1) |  | 62 |
| TRN_AADJ62 | C120･C121/C130 | オーソリアドバイス | JIS2 |  | 62 |
| TRN_AADI62 | C120･C121/C130 | オーソリアドバイス | JIS1 IC |  | 62 |
| TRN_AADI262 | C120･C121/C130 | オーソリアドバイス | JIS2 IC |  | 62 |
| TRN_AADM62 | C120･C121/C130 | オーソリアドバイス | Manual |  | 62 |
| TRN_AADT63 | C120･C121/C130 | オーソリアドバイス | TRACK2(JIS1) |  | 63 |
| TRN_AADJ63 | C120･C121/C130 | オーソリアドバイス | JIS2 |  | 63 |
| TRN_AADI63 | C120･C121/C130 | オーソリアドバイス | JIS1 IC |  | 63 |
| TRN_AADI263 | C120･C121/C130 | オーソリアドバイス | JIS2 IC |  | 63 |
| TRN_AADM63 | C120･C121/C130 | オーソリアドバイス | Manual |  | 63 |
| TRN_AADT6263 | C120･C121/C130 | オーソリアドバイス | TRACK2(JIS1) |  | 62&63 |
| TRN_AADJ6263 | C120･C121/C130 | オーソリアドバイス | JIS2 |  | 62&63 |
| TRN_AADI6263 | C120･C121/C130 | オーソリアドバイス | JIS1 IC |  | 62&63 |
| TRN_AADI26263 | C120･C121/C130 | オーソリアドバイス | JIS2 IC |  | 62&63 |
| TRN_AADM6263 | C120･C121/C130 | オーソリアドバイス | Manual |  | 62&63 |

#### 売上
| トランザクションタイプ | 電文種別 | 取引タイプ | 入力モード | PIN | 拡張ビット |
|---|---|---|---|---|---|
| TRN_FINTN | C200/C210 | ショッピング売上 | TRACK2(JIS1) | なし |  |
| TRN_FINJN | C200/C210 | ショッピング売上 | JIS2 | なし |  |
| TRN_FINMN | C200/C210 | ショッピング売上 | Manual | なし |  |
| TRN_FINTP | C200/C210 | ショッピング売上 | TRACK2(JIS1) | あり |  |
| TRN_FINJP | C200/C210 | ショッピング売上 | JIS2 | あり |  |
| TRN_FINMP | C200/C210 | ショッピング売上 | Manual | あり |  |
| TRN_FINTN62 | C200/C210 | ショッピング売上 | TRACK2(JIS1) | なし | 62 |
| TRN_FINJN62 | C200/C210 | ショッピング売上 | JIS2 | なし | 62 |
| TRN_FINMN62 | C200/C210 | ショッピング売上 | Manual | なし | 62 |
| TRN_FINTP62 | C200/C210 | ショッピング売上 | TRACK2(JIS1) | あり | 62 |
| TRN_FINJP62 | C200/C210 | ショッピング売上 | JIS2 | あり | 62 |
| TRN_FINMP62 | C200/C210 | ショッピング売上 | Manual | あり | 62 |
| TRN_FINTN63 | C200/C210 | ショッピング売上 | TRACK2(JIS1) | なし | 63 |
| TRN_FINJN63 | C200/C210 | ショッピング売上 | JIS2 | なし | 63 |
| TRN_FINMN63 | C200/C210 | ショッピング売上 | Manual | なし | 63 |
| TRN_FINTP63 | C200/C210 | ショッピング売上 | TRACK2(JIS1) | あり | 63 |
| TRN_FINJP63 | C200/C210 | ショッピング売上 | JIS2 | あり | 63 |
| TRN_FINMP63 | C200/C210 | ショッピング売上 | Manual | あり | 63 |
| TRN_FINTN6263 | C200/C210 | ショッピング売上 | TRACK2(JIS1) | なし | 62&63 |
| TRN_FINJN6263 | C200/C210 | ショッピング売上 | JIS2 | なし | 62&63 |
| TRN_FINMN6263 | C200/C210 | ショッピング売上 | Manual | なし | 62&63 |
| TRN_FINTP6263 | C200/C210 | ショッピング売上 | TRACK2(JIS1) | あり | 62&63 |
| TRN_FINJP6263 | C200/C210 | ショッピング売上 | JIS2 | Ⓡ あり | 62&63 |
| TRN_FINMP6263 | C200/C210 | ショッピング売上 | Manual | あり | 62&63 |
| TRN_DEBIT | D200/D210 | デビット売上 | TRACK2(JIS1) | あり |  |
| TRN_JDEBIT | D200/D210 | J-DEBIT売上 | JIS2 | あり |  |
| TRN_DEBIT62 | D200/D210 | デビット売上 | TRACK2(JIS1) | あり | 62 |
| TRN_JDEBIT62 | D200/D210 | J-DEBIT売上 | JIS2 | あり | 62 |
| TRN_FININ | ダミー | ショッピング売上（ICダミー） IC なし |  |  |  |
| TRN_FINIP | ダミー | ショッピング売上（ICダミー） IC あり |  |  |  |
| TRN_FININ62 | ダミー | ショッピング売上（ICダミー） IC なし 62 |  |  |  |
| TRN_FINIP62 | ダミー | ショッピング売上（ICダミー） IC あり 62 |  |  |  |
| TRN_FININ63 | ダミー | ショッピング売上（ICダミー） IC なし 63 |  |  |  |
| TRN_FINIP63 | ダミー | ショッピング売上（ICダミー） IC あり 63 |  |  |  |
| TRN_FININ6263 | ダミー | ショッピング売上（ICダミー） IC なし 62&63 |  |  |  |
| TRN_FINIP6263 | ダミー | ショッピング売上（ICダミー） IC あり 62&63 |  |  |  |

#### 売上アドバイス
| トランザクションタイプ | 電文種別 | 取引タイプ | 入力モード | PIN | 拡張ビット |
|---|---|---|---|---|---|
| TRN_FADT | C220･C221/C230 | 売上アドバイス | TRACK2(JIS1) |  |  |
| TRN_FADJ | C220･C221/C230 | 売上アドバイス | JIS2 |  |  |
| TRN_FADI | C220･C221/C230 | 売上アドバイス | JIS1 IC |  |  |
| TRN_FADI2 | C220･C221/C230 | 売上アドバイス | JIS2 IC |  |  |
| TRN_FADM | C220･C221/C230 | 売上アドバイス | Manual |  |  |
| TRN_FADT62 | C220･C221/C230 | 売上アドバイス | TRACK2(JIS1) |  | 62 |
| TRN_FADJ62 | C220･C221/C230 | 売上アドバイス | JIS2 |  | 62 |
| TRN_FADI62 | C220･C221/C230 | 売上アドバイス | JIS1 IC |  | 62 |
| TRN_FADI262 | C220･C221/C230 | 売上アドバイス | JIS2 IC |  | 62 |
| TRN_FADM62 | C220･C221/C230 | 売上アドバイス | Manual |  | 62 |
| TRN_FADT63 | C220･C221/C230 | 売上アドバイス | TRACK2(JIS1) |  | 63 |
| TRN_FADJ63 | C220･C221/C230 | 売上アドバイス | JIS2 |  | 63 |
| TRN_FADI63 | C220･C221/C230 | 売上アドバイス | JIS1 IC |  | 63 |
| TRN_FADI263 | C220･C221/C230 | 売上アドバイス | JIS2 IC |  | 63 |
| TRN_FADM63 | C220･C221/C230 | 売上アドバイス | Manual |  | 63 |
| TRN_FADT6263 | C220･C221/C230 | 売上アドバイス | TRACK2(JIS1) |  | 62&63 |
| TRN_FADJ6263 | C220･C221/C230 | 売上アドバイス | JIS2 |  | 62&63 |
| TRN_FADI6263 | C220･C221/C230 | 売上アドバイス | JIS1 IC |  | 62&63 |
| TRN_FADI26263 | C220･C221/C230 | 売上アドバイス | JIS2 IC |  | 62&63 |
| TRN_FADM6263 | C220･C221/C230 | 売上アドバイス | Manual |  | 62&63 |

#### 取消アドバイス
| トランザクションタイプ | 電文種別 | 取引タイプ | 入力モード | PIN | 拡張ビット |
|---|---|---|---|---|---|
| TRN_REVTA | C420･C421/C430 | 取消アドバイス | TRACK2(JIS1) | 対オーソリ/オーソリアドバイス |  |
| TRN_REVJA | C420･C421/C430 | 取消アドバイス | JIS2 | 対オーソリ/オーソリアドバイス |  |
| TRN_REVMA | C420･C421/C430 | 取消アドバイス | Manual | 対オーソリ/オーソリアドバイス |  |
| TRN_REVTF | C420･C421/C430 | 取消アドバイス | TRACK2(JIS1) | 対売上/売上アドバイス |  |
| TRN_REVJF | C420･C421/C430 | 取消アドバイス | JIS2 | 対売上/売上アドバイス |  |
| TRN_REVMF | C420･C421/C430 | 取消アドバイス | Manual | 対売上/売上アドバイス |  |
| TRN_DREVTA | D420･D421/D430 | 取消アドバイス（Debit） | TRACK2(JIS1) | 対オーソリ/オーソリアドバイス |  |
| TRN_DREVJA | D420･D421/D430 | 取消アドバイス（J-Debit） | JIS2 | 対オーソリ/オーソリアドバイス |  |
| TRN_DREVTF | D420･D421/D430 | 取消アドバイス（Debit） | TRACK2(JIS1) | 対売上/売上アドバイス |  |
| TRN_DREVJF | D420･D421/D430 | 取消アドバイス（J-Debit） | JIS2 | 対売上/売上アドバイス |  |
| TRN_ARQC_REVI | Q420･Q421/Q430 | 取消アドバイス（IC ARQC） | JIS1 IC | 対IC ARQCオーソリ |  |
| TRN_ARQC_REVI2 | Q420･Q421/Q430 | 取消アドバイス（IC ARQC） | JIS2 IC | 対IC ARQCオーソリ |  |


---

### 4.3.2. トランザクションタイプ（取引系電文以外）

| トランザクションタイプ | 電文種別 | 取引タイプ | 備考 |
|---|---|---|---|
| TRN_RCNWI | C522/C532 | 一括精査(ISSURE) | 一括精査対応のクレジット接続センターのみ |
| TRN_RCNPI | P522/P532 | 個社別精査(ISSURE) | 個社別精査（カウンタ交換）対応のクレジット接続センターのみ |
| TRN_CNTRL | C644 | 汎用:制御依頼 | ネットワーク制御依頼電文 |
| TRN_RPTERR | E644 | アドミニストラティブ | エラーレポート電文 |
| TRN_ECHO | C804/C814 | エコーテスト | エコーテスト |
| TRN_CUT | C804/C814 | カットオーバー | カットオーバー |
| TRN_SIGNON | C804/C814 | 開局 | 開局 |
| TRN_SIGNOFF | C804/C814 | 閉局 | 閉局 |
| TRN_OTHER | - | - | FEXICSからのイベント通知受信 |

---

### 4.3.3. アプリケーションタイプ

アプリケーションタイプでは、業務内容の識別を行います。
APIのパラメータに指定するアプリケーションタイプによって、電文上のBIT3とBIT24に対応する値がセットされます。

#### クレジットサービス
| アプリケーションタイプ | BIT3設定値 | BIT24設定値 | 業務内容 | 有効電文種別 |
|---|---|---|---|---|
| APL_AUTHREQ | 000000 | 100 | オーソリ、承認後オーソリ | 11XX |
| APL_AUTHCAN | 200000 | 100 | オーソリ取消/返品、承認後オーソリ取消/返品 | 11XX |
| APL_FORECASH | 010000 | 100 | 海外キャッシング | 11XX |
| APL_AUTHPRE | 000000 | 101 | 事前承認 | 11XX |
| APL_AUTHPCAN | 200000 | 101 | 事前承認取消/返品 | 11XX |
| APL_AUTHINQ | 360000 | 108 | 無効カード照会 | 11XX |
| APL_FNCEREQ | 000000 | 200 | 売上 | 12XX |
| APL_FNCECAN | 200000 | 200 | 売上取消/返品 | 12XX |
| APL_FNCEPRE | 000000 | 201 | 承認後売上 | 12XX |
| APL_FNCEPCAN | 200000 | 201 | 承認後売上取消/返品 | 12XX |

#### デビットサービス
| アプリケーションタイプ | BIT3設定値 | BIT24設定値 | 業務内容 | 有効電文種別 |
|---|---|---|---|---|
| APL_DEBINQ | 310000 | 108 | デビット残高照会 | 11XX |
| APL_DEBREQ | 000000 | 200 | デビット売上 | 12XX |
| APL_DEBCAN | 200000 | 201 | デビット売上取消/返品 | 12XX |

#### ギフトサービス
| アプリケーションタイプ | BIT3設定値 | BIT24設定値 | 業務内容 | 有効電文種別 |
|---|---|---|---|---|
| APL_GIFTACT | 000000 | 101 | アクティベート | 11XX |
| APL_GIFTACAN | 200000 | 101 | アクティベート取消 | 11XX |
| APL_GIFTINQ | 010000 | 101 | ギフト残高照会 | 11XX |
| APL_GIFTCHRG | 200000 | 201 | チャージ（入金） | 12XX |
| APL_GIFTCCAN | 000000 | 201 | チャージ（入金）取消 | 12XX |
| APL_GIFTREQ | 000000 | 200 | ギフト売上（出金） | 12XX |
| APL_GIFTCAN | 200000 | 200 | ギフト売上（出金）取消/返品 | 12XX |

