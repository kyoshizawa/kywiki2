# 4.4 電文作成方法

本節では、電文作成方法について説明する。

---

## 4.4.1 電文作成手順

業務電文を作成する場合、以下の手順に従って処理を行う。

1) 電文を構築するためのバッファ域（`fx_XMsg`）を  
   メモリ上に確保する。

2) PIN データがある場合は、  
   PIN データおよび会員番号を指定し  
   `FX_GenPinBlk()` をコールして、  
   入力暗証番号（ISO 0 PIN Block）を作成する。

3) `FX_BuildAuthMsg()` 等の Build 系 API をコールして、  
   業務電文を構築する。

4) 業務的に必要な場合は、  
   オプションのデータ項目を  
   `FX_SetField()` を使用して上書きする。

---

## 4.4.2 取消／返品電文作成の API コール順序

取消電文または返品電文を作成する場合は、  
以下の順序で API をコールする。

1) 電文作成用バッファ（`fx_XMsg`）を  
   メモリ上に確保する。

2) `FX_BuildCancelMsg()` をコールして、  
   取消／返品用の業務電文を作成する。

3) 業務的に必要な場合は、  
   オプションのデータ項目を  
   `FX_SetField()` を使用して上書きする。

---

# 4.5 PIN ブロック暗号化

クレジット決済センターの高い機密基準を遵守するために、  
暗号化はすべて FEXICS 内で行われる。

エンドユーザーによる暗号処理機能および  
キー関連情報への直接のアクセスはできない。

これは、ネットワーク上の電文全体の暗号化に限らず、  
PIN（暗証番号）の暗号化についても同様である。

したがって、FEXICS のアプリケーションプログラムでは  
**平文の ISO 0 PIN Block** のみを使用する。


---

## 4.5.1 PIN Block の暗号化手順  
（仕向アプリケーション：要求電文送信時）

PIN Block の暗号化は、以下の手順で行われる。

1) アプリケーションは、`FX_GenPinBlk()` によって、  
   会員番号および PIN データを元に  
   **「平文の ISO 0 PIN Block」** を作成する。

2) アプリケーションは、  
   `FX_BuildAuthMsg()` または `FX_BuildCancelMsg()` をコールする際、  
   (1) で作成した **「平文の ISO 0 PIN Block」** を  
   `pchPinBlk`（入力暗証番号パラメータ）の値として使用する。

3) API 処理プロセスは、  
   `FX_SendAuth()` または `FX_SendAndCaptureAuth()` がコールされた段階で、  
   DLL 内部において要求電文の BIT52 に設定されている  
   **「平文の ISO 0 PIN Block」** を暗号化し、  
   送受信プロセスへ送信する。
