## 4.4 電文作成方法

本節では、電文作成方法について説明する。

---

### 4.4.1 仕向業務電文作成のAPIコール順序 

業務電文を作成する場合、以下の手順に従って処理を行う。

1) 電文を構築するためのバッファ域（`fx_XMsg`）を  
   メモリ上に確保する。

2) PIN データがある場合は、  
   PIN データおよび会員番号を指定し  
   `FX_GenPinBlk()` をコールして、  
   入力暗証番号（ISO 0 PIN Block）を作成する。

3) `FX_BuildAuthMsg()` 等の Build 系 API をコールして、  
   業務電文を構築する。

4) 業務的に必要な場合は、  
   オプションのデータ項目を  
   `FX_SetField()` を使用して上書きする。

---

### 4.4.2 取消／返品電文作成の API コール順序

取消電文または返品電文を作成する場合は、  
以下の順序で API をコールする。

取消対象元電文の通番がアプリケーションに既知であれば、FX_BuildMsg()で取消/返品電文を作成するのではなく、FX_BuildCancelMsg()を使用する。

1) 電文作成用バッファ（`fx_XMsg`）を  
   メモリ上に確保する。

2) `FX_BuildCancelMsg()` をコールして、  
   取消／返品用の業務電文を作成する。

3) 業務的に必要な場合は、  
   オプションのデータ項目を  
   `FX_SetField()` を使用して上書きする。

---

## 4.5 PIN ブロック暗号化

クレジット決済センターの高い機密基準を遵守するために、  
暗号化はすべて FEXICS 内で行われる。

エンドユーザーによる暗号処理機能および  
キー関連情報への直接のアクセスはできない。

これは、ネットワーク上の電文全体の暗号化に限らず、  
PIN（暗証番号）の暗号化についても同様である。

したがって、FEXICS のアプリケーションプログラムでは  
**平文の ISO 0 PIN Block** のみを使用する。


---

### 4.5.1 PIN Block の暗号化手順  
（仕向アプリケーション：要求電文送信時）

PIN Block の暗号化は、以下の手順で行われる。

1) アプリケーションは、`FX_GenPinBlk()` によって、  
   会員番号および PIN データを元に  
   **「平文の ISO 0 PIN Block」** を作成する。

2) アプリケーションは、`FX_BuildAuthMsg()` または `FX_BuildCancelMsg()` をコールする際、
   (1) で作成した **「平文の ISO 0 PIN Block」** を  
   `pchPinBlk`（入力暗証番号パラメータ）の値として使用する。

3) API 処理プロセスは、  
   `FX_SendAuth()` または `FX_SendAndCaptureAuth()` がコールされた段階で、  
   DLL 内部において要求電文の BIT52 に設定されている  
   **「平文の ISO 0 PIN Block」** を暗号化し、  
   送受信プロセスへ送信する。

---

## 4.6 会員番号情報の指定形式

CARDNET 手順での会員番号のフォーマットと、API への指定方式の関係を示します。  
仕向アプリケーションでは、会員番号を端末などからの **3 通りの入力形式**によって、それぞれに対応した方法でフォーマットしてから API をコールします。

対象となる API は、下記の 3 つです。

- `FX_BuildAdviceMsg()` のパラメータ `pchAccountNum`
- `FX_BuildAuthMsg()` のパラメータ `pchAccountNum`
- `FX_GenPinBlk()` のパラメータ `pchAccountNum`

---

### 4.6.1 TRACK2（JIS1）磁気ストライプ／IC カード／Debit カード

**Format** : `LLVAR(ans..37)`  
**Size** : 最大 39 byte

JIS1 磁気ストライプは、すべて 8 ビットの ASCII 文字列として記述します。  
実際の磁気ストライプから読まれたイメージを、キャラクターイメージで記述することになります。

- フィールド長  
  - LL 部分：2 バイト  
  - データ部：最大 37 バイト  
  - 合計最大：39 バイト
- LL 部分には、データ部の長さ（磁気ストライプ長）を指定します。
- データ部には、最大 37 バイトの文字列が入ります。

**会員番号の位置**

- データ値の 1 桁目から最大 19 桁目までの文字列の中で  
  **1 桁目から分離符号「=」までの数字**

**FX_BuildAdviceMsg() / FX_BuildAuthMsg() での処理**

1. ここで指定された値（LLVAR）を、そのまま  
   ISO8583 電文の第 2 トラック情報［BIT35］にコピーします。
2. 会員番号を、ISO8583 電文の会員番号［BIT2］に格納します。

**例**

```
373540000000181108=01011012080000000000
LL  会員番号        LL 有効期限
```

---

### 4.6.2 JIS2 磁気ストライプ／IC カード／J-Debit カード

**Format** : `LLLVAR(ans69)`  
**Size** : 71 byte 固定

JIS2 磁気ストライプは、ASCII 文字列で **データ長 69 バイト固定**です。  
69 桁すべてを記述します。

**会員番号の位置**

- データ値の **11 桁目から 26 桁目までの 16 桁**

**FX_BuildAdviceMsg() / FX_BuildAuthMsg() での処理**

1. ここで指定された値（LLLVAR）を、そのまま  
   ISO8583 電文のトラック情報［BIT47］にコピーします。
2. 会員番号を、ISO8583 電文の会員番号［BIT2］に格納します。

**例**

```
069a90000966135400000001811085010000000000010100000000000000000000000000
LL           会員番号(11桁目から16桁)        有効期限
```

---

### 4.6.3 マニュアル入力

**Format** : `LLVAR(ans..19) + YYMM(n4)`  
**Size** : 最大 25 byte

マニュアル入力では、通常の磁気ストライプとは異なり、  
カードの有効期限情報も入力します。

そのため、API に対しては **会員番号と有効期限を連結した文字列**で指定します。

- 会員番号  
  - LL 部分：2 バイト  
  - データ部：最大 19 バイト  
  - 合計最大：21 バイト
- LL 部分には、データ部のみの長さ（実際の会員番号長）を指定します。
- 会員番号の直後に、有効期限を 4 バイトの数字（YYMM）で指定します。

**FX_BuildAdviceMsg() / FX_BuildAuthMsg() での処理**

1. YYMM で指定された有効期限を、  
   ISO8583 電文の有効期限［BIT14］にコピーします。
2. 会員番号を、ISO8583 電文の会員番号［BIT2］に格納します。
3. LLVAR の直後の 4 桁を有効期限情報として、  
   ISO8583 電文の有効期限［BIT14］にコピーします。

**例**

```
1635400000001811080101
LL  会員番号      有効期限
```

---

## 4.7 郵貯共用カードの判定

郵貯共用カードでの取引の場合、  
JIS2 トラック情報の **51 桁目から 66 桁目までの合計 16 バイト**を  
会員番号として設定します。

FEXICS API では、  
トラック情報の **29 桁目からの 5 バイト（業態＋会社コード）**を参照し、  
その値が **「99900」** の場合、郵貯共用カードと判定します。

この場合、FEXICS が自動的に会員番号の設定を行います。

**例**

```
069a900009661352812345678901299900000000000101000000003540000000181108000
LL                   業態＋会社コードエリア     有効期限   会員番号(51桁目から66桁)
```
