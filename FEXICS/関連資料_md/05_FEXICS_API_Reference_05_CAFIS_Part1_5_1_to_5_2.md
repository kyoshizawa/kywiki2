# 第5章 CAFIS 接続のプログラミング要素

この章では、CAFIS 接続サービスを使用する上で、重要となるプログラミング要素について説明しています。

CAFIS 接続サービスでは、iD サービスを除き FEXICS API による業務電文の作成は行ないません。  
スルーフォワーディング方式では、送受信する CAFIS 電文の共通制御ヘッダを除くすべての業務電文を  
アプリケーションプログラムにて編集・解析します。  
そのため、CAFIS の仕様についての知識の習得が必要になります。

---

## 5.1. 通番

一連の取引電文に固有となる値を **通番**、または **ID** とします。

CAFIS サービスでは、以下の 3 項目を ID として取り扱います。

- データ部 1-0 の端末識別番号［13 桁］
- 端末処理通番［5 桁］
- 処理年月日［6 桁］

各 3 項目は、要求電文とそれに対応する応答電文、および障害取消電文にて  
同一の値を保持します。

また別に FEXICS Daemon は、共通制御ヘッダ部の  
**仕向処理通番［6 桁］** を管理し、採番します。

仕向処理通番は、カットオーバー日付により更新されますので、  
日次業務の終了、または開始時に **FX_SendCutOverMsg()** をコールして、  
必ず通番を “000001” にクリアしてください。

24 時間運用を行なう場合は、日替わり処理として  
任意のタイミングで **FX_SendCutOverMsg()** をコールする必要があります。

---

## 5.2. iD サービスにおける電文作成方法

CAFIS 接続ではスルーフォワーディング方式により、  
基本的に電文作成および編集はユーザーアプリケーションにて行っていただきますが、  
**iD サービス業務についてのみ** 電文作成用の API による電文作成が可能です。

iD サービス用電文編集 API は、以下の 3 種類があります。

- 鍵配信要求電文用
- 通常の要求・アドバイス電文用
- 取消・返品電文用

アプリケーションは、クライアントから受取った基本的なオーソリ用データを  
パラメータとしてこれらの API をコールして、  
CAFIS 手順の電文を作成することが可能です。

---

### 5.2.1. 各要求電文作成の API コール順序

鍵配信要求およびオーソリ要求や売上要求、取消電文を作成する際の手順は  
以下のとおりです。

1. 電文を構築するためのバッファ域（char 型）をメモリ上に確保します。
2. 各電文作成 API に応じたデータ項目を指定して、電文作成 API をコールします。  
   各 API の入力項目については、電文編集 API リファレンスの章を参照してください。

---

### 5.2.2. 取消／返品電文作成 API について

取消・返品電文を作成する API は  
**FX_BuildCancelMsg_iD()** と **FX_BuildCancelMsg2_iD()** の 2 種類があり、  
それぞれ作成方法が異なります。

- **FX_BuildCancelMsg_iD()**  
  電文通番をキーにジャーナルから取消対象となる元電文を抽出し、  
  取引金額や支払い方法など元電文内容を保障する項目を正確に対応付けて  
  取消・返品電文を作成する。

- **FX_BuildCancelMsg2_iD()**  
  元電文を保障する項目についても引数入力された値によって  
  取消・返品電文を作成する。

※ **FX_BuildCancelMsg_iD()** では、  
元電文の端末識別番号、取引通番、取引日付の情報のみで  
取消電文を作成することが可能です。

ユーザーアプリケーションによるオフライン取引などで、  
FEXICS のジャーナルに保持されていない取引に対して取消を行う際は、  
**FX_BuildCancelMsg2_iD()** にて取消電文を作成する必要があります。
