# 3. FEXICS操作コマンド

本章では、FEXICSに標準で提供されている操作コマンドの使用法を述べています。
すべての操作コマンドは、単純なコマンド・プロンプトから実行する形で提供されるとともに、
FEXICSを各社の製品内に組み込めるようにAPIとしても提供されています。

各コマンドは、接続するクレジット決済センター毎に用意されています。

| Command   | 処理種別 (引数) | 有効決済センター | 内容 |
|------------|----------------|----------------|------|
| fxumain    | - | CN, CF | FEXICS Daemonを起動する |
| fxctrl     | shutdown | CN, CF | FEXICS Daemonに終了依頼を送信する（仕掛中電文は処理後） |
|            | shutdown force | CN, CF | FEXICS Daemonに強制終了依頼を送信する（仕掛中電文の有無に関わらず） |
|            | recovery | CN, CF | FEXICS Daemonが異常終了した後の障害回復処理を依頼する |
|            | signon | CN, CF | FEXICS Daemonを強制的にサインオン（開局）状態にする |
|            | signoff | CN, CF | FEXICS Daemonを強制的にサインオフ（閉局）状態にする |
|            | cutover | CN, CF | FEXICS Daemonのカットオーバー日付を強制的にシステム日付にする |
|            | status | CN, CF | FEXICS Daemonの業務ステータスを表示する |
| fxmsg      | signon | CN, CF | クレジット決済センターにサインオン（開局）要求を送信する |
|            | signoff | CN, CF | クレジット決済センターにサインオフ（閉局）要求を送信する |
|            | cutreq | CN, CF | クレジット決済センターにカットオーバー依頼要求を送信する |
|            | cancel | CN, CF | クレジット決済センターに指定取引の取消要求を送信する |
|            | cntreq | CF | クレジット決済センターにカウンタ照会要求を送信する |
| fxsession  | - | CN, CF | FEXICS Daemonとクレジット決済センター間のTCPセッション状況を表示する |
|            | purge | CF | 経路を開放する |
| fxview     | journal | CN, CF | ジャーナル情報を出力する（参照ファイル：ジャーナルファイル） |
|            | reconcile | CN, CF | 精査履歴情報を出力する（参照ファイル：reconcile.log） |
|            | event | CN, CF | イベント情報を出力する（参照ファイル：event.log） |
|            | sum | CN, CF | 精査情報を出力する（参照ファイル：sum.dat） |
| fxsetlicense | (ライセンスキー) | CN, CF | ライセンスファイルを作成する |
| fxsetkey   | (16 or 32桁のKEK) | CN | 暗号化キーファイルにKEK情報を保存する |
| fxdumpkey  | - | CN | キーファイル情報を出力する |

fxumain以外の各FEXICS操作コマンドは、基本的にFEXICS Daemonが起動している環境でのみ使用可能です。

また、クライアント機にコンフィグレーションファイルおよび操作コマンドを配置することで、リモート機にて起動しているFEXICS Daemonに対して各コマンドを実行することが可能です。

fxsetlicense、fxsetkey、fxdumpkeyコマンドについては、FEXICS Daemon稼働機でのみ使用可能となります。

各コマンドの詳細な説明については、次章以降に記載します。


------------------------------------------------------------------------

## 3.1. FEXICS Daemon

### コマンドフォーマット

- `fxumain_cn` ： CARDNETセンター接続用 FEXICS Daemon コマンド  
- `fxumain_cf` ： CAFISセンター接続用 FEXICS Daemon コマンド  

上記プログラムをパラメータなしで実行します。  
起動した FEXICS Daemon は、クレジット決済センターとの接続が可能な状態となります。  

FEXICS Daemon を fxctrl コマンドによる shutdown 処理以外の方法で終了（システムダウンを含む）した場合、  
`fxumain_cn`（`fxumain_cf`）実行後、fxctrl コマンドによる **recovery 処理**を必ず行ってください。  

FEXICS Daemon は、起動時に「licensekey.dat」ファイルに格納されたライセンス情報と、  
起動マシンの情報を比較します。  

ライセンスファイルの有効性を確認できなかった場合は起動できません。  
申請されたライセンス内容とマシン情報をご確認ください。  


---

## 3.2. fxdstart コマンド

### コマンドフォーマット

- `fxdstart_cf` ： アプリケーション入替処理後、FEXICS Daemon を起動します。（CAFISセンター用）  
- `fxdstart_cn` ： アプリケーション入替処理後、FEXICS Daemon を起動します。（CARDNETセンター用）  

### 前提条件

1. 本コマンドでエラーが発生した場合、その時点で処理を終了し、FEXICS Daemon は起動しません。  
2. 設定ファイルは、既存で使用している設定ファイルをコピーして使用します。  

### 説明

本コマンドは、FEXICS Daemon を停止し、アプリケーション入替ツールを起動後、  
FEXICS Daemon を起動します。  

アプリケーション入替処理については「1.2.1 fxreplace コマンド」をご参照ください。


------------------------------------------------------------------------

## 3.3. fxctrl コマンド

FEXICS Daemon の動作は、fxctrl コマンドラインプログラムで制御します。

### コマンドフォーマット

    fxctrl_cn <parameter>  ： FEXICS Daemon for CARDNET の動作を制御します。
    fxctrl_cf <parameter>  ： FEXICS Daemon for CAFIS の動作を制御します。

#### `<parameter>`

-   **shutdown**\
    アプリケーションプログラムがすべて停止した後で、FEXICS Daemon
    を終了します。

-   **shutdown force**\
    アプリケーションプログラムの有無やクレジット決済センターとの接続状況に関わらず、FEXICS
    Daemon を強制終了します。

-   **recovery**\
    FEXICS Daemon
    の強制終了などにより残された仕掛かり中の電文の障害回復処理を行います。

-   **signon**\
    FEXICS Daemon の稼働状態をサインオン状態にします。

-   **signoff**\
    FEXICS Daemon の稼働状態をサインオフ状態にします。

-   **status**\
    FEXICS Daemon の内部状況を表示します。

-   **cutover**\
    FEXICS Daemon のカット対象日付にシステム日付をセットします。

------------------------------------------------------------------------

### 3.3.1 終了 (shutdown)

FEXICS Daemonを正常終了させます。

#### コマンドフォーマット

    [ fxctrl_cn | fxctrl_cf ] shutdown
    ... API ： FX_CtrlShutdown()

要求が出された時点で仕掛中の処理を完了させた後、全てのセッションを切断してFEXICS
Daemonを終了します。\
終了処理中はアプリケーションからの新たな電文要求に対してはエラーを戻します。

FEXICS Daemonがサインオン状態の場合は、終了できません。\
サインオフ状態を確認してから実行してください。

------------------------------------------------------------------------

### 3.3.2 強制終了 (shutdown force)

fxctrlコマンドの shutdown force
は、何らかの理由でアプリケーションを停止できないなど、 FEXICS
Daemonを正常終了できない場合に、強制的にプログラムを終了させるために使用します。

#### コマンドフォーマット

    [ fxctrl_cn | fxctrl_cf ] shutdown force
    ... API ： FX_CtrlShutdown()

このコマンドはFEXICS
Daemonを、仕掛中の電文処理の有無にかかわらず終了させます。

仕掛中の電文を完結させるためには、FEXICS
Daemonの再起動後に障害回復処理（recovery）を実行する必要があります。


### 3.3.3. 障害回復 (recovery)

recoveryは、FEXICS
Daemonをshutdown以外の方法で終了（システムダウンを含む）した場合に、
処理が完了していない電文に対して取消や再送を行い、取引の整合性を回復します。

回復処理を実行中は、業務電文の送受信等は行わないでください。

------------------------------------------------------------------------

#### コマンドフォーマット

    [ fxctrl_cn | fxctrl_cf ] recovery
    API ： FX_CtrlRecovery()

------------------------------------------------------------------------

システムの障害やFEXICS Daemonの強制終了によって、
仕掛中のまま残された電文や、リカバリー対象となっている電文に対して、
下記の障害回復処理を行います。

当日分のジャーナルファイルの中で、以下に該当する電文が対象となります。

-   外部イベントフラグが「送信」または「受信」のままである
-   または内部イベントフラグが「リカバリー対象」となっている
-   かつシステム取消されていない電文

------------------------------------------------------------------------

#### ■ 電文種別ごとの障害回復処理

**【CARDNET接続サービス】**

-   オーソリ電文 (100) ...... 電文取消 (420)
-   オーソリアドバイス電文 (120) ...... 電文取消 (420)
-   売上電文 (200) ...... 電文取消 (420)
-   売上アドバイス (220) ...... 電文再送 (420)
-   売上電文 (200) ...... 電文取消 (420)

------------------------------------------------------------------------

**【CAFIS接続サービス】**

-   与信電文 (3110) ...... 取消確認指令 (8930)
-   売上電文 (3210) ...... 取消確認指令 (8930)
-   取消電文 (3310) ...... 取消確認指令 (8930)
-   照会電文 (3410) ...... 取消確認指令 (8930)
-   その他電文 (3510) ...... 取消確認指令 (8930)
-   事故カード中継電文 (6110) ...... 取消確認指令 (8930)
-   取消確認指令 (8930) ...... 取消確認再指令 (8940)
-   取消指令 (8910) ...... 取消再指令 (8920)

------------------------------------------------------------------------

このコマンドは、FEXICS Daemonがサインオン状態のときにのみ実行できます。


------------------------------------------------------------------------

### 3.3.4. サインオン状態設定（signon）

    [ fxctrl_cn | fxctrl_cf ] signon
    API: FX_CtrlSignOn()

Daemonを強制的にサインオン状態にします。
センターへのサインオン要求は送信しません。

------------------------------------------------------------------------

### 3.3.5. サインオフ状態設定（signoff）

    [ fxctrl_cn | fxctrl_cf ] signoff
    API: FX_CtrlSignOff()

Daemonを強制的にサインオフ状態にします。
センターへのサインオフ要求は送信しません。

------------------------------------------------------------------------

### 3.3.6. 状態表示（status）

    [ fxctrl_cn | fxctrl_cf ] status

内部状態を表示します。

------------------------------------------------------------------------

### 3.3.7. カットオーバー日付設定（cutover）

    [ fxctrl_cn | fxctrl_cf ] cutover

カット対象日付をシステム日付に合わせます。
