## 5. FEXICS 出力ファイル

FEXICSでは、電文はCARDNETとCAFIS共に下記の3つのファイルに記録されます。

-   ジャーナルファイル（取引情報）
-   精査電文記録ファイル（精査情報）
-   イベントファイル（管理情報）

また、システム稼働情報を下記のファイルに記録します。

-   エラーログファイル（障害情報）
-   システムログファイル（各種トレース情報）
-   アプリケーション入替ログファイル（処理情報）

その他、FEXICS内部保存ファイルとして下記情報が記録されます。

-   精査集積ファイル（精査集積情報）
-   内部情報記録ファイル
-   暗号化キーファイル

------------------------------------------------------------------------

### ■ ファイル識別子

各情報ファイルは接続しているクレジット決済センター毎に記録されます。\
ファイル名には以下の識別子が使用されます。

-   **cn** ：CARDNET接続用ファイル\
    例）`j1_cn.dat`（CARDNET接続用ジャーナルファイル）

-   **cf** ：CAFIS接続用ファイル\
    例）`event_cf_040401.log`（CAFIS接続用イベントファイル）

------------------------------------------------------------------------

### ■ ファイル配置構成（CARDNET接続例）

    %FX_ROOT%
     ├─ journal
     │   ├─ j1_cn.dat / j1_cn.idx    当日分ジャーナル
     │   ├─ j2_cn.dat / j2_cn.idx    前日分ジャーナル
     │   ├─ j3_cn.dat / j3_cn.idx    前前日分ジャーナル
     │   └─ j_cn_yymmdd.dat / .idx   過去分ジャーナル
     │
     ├─ log
     │   ├─ reconcile_cn_yymmdd.log
     │   ├─ event_cn_yymmdd.log
     │   ├─ fxd_cn_yymmdd.stdtxt
     │   ├─ fxd_cn_yymmdd.errtxt
     │   ├─ fxapi_yymmdd.stdtxt
     │   ├─ fxapi_yymmdd.errtxt
     │   ├─ fxreplace_cn.stdtxt
     │   └─ fxreplace_cn.errtxt
     │
     └─ save
         ├─ sum_cn_yymmdd.dat
         ├─ fxsave_cn.dat
         └─ crypt_cn.dat

※同時接続時は、同一ディレクトリ内に各センター用ファイルが並列保存されます。

------------------------------------------------------------------------

### ■ ログ生成・切替・削除タイミング

ログファイルは **カット対象日付 または システム日付単位**
で管理されます。\
保持日数はコンフィグレーション設定に従い、超過ファイルは自動削除されます。

| タイミング         | 処理内容                                          |
| ------------- | --------------------------------------------- |
| Daemon起動時     | 当日ログが存在しない場合は空ファイルを作成                         |
| カットオーバー時      | ジャーナル／精査集積ファイルを切替、次カット対象日分ログを準備、保持期限切れファイルを削除 |
| 日付変更後の最初の書込み時 | システムログ／エラーログ／イベントログを生成                        |

------------------------------------------------------------------------

### ■ 注意事項

-   ログファイルへの直接操作は禁止
-   参照可能なのは以下のみ
    -   エラーログ
    -   システムログ

それ以外のログを直接編集・書込みする行為は禁止されています。

------------------------------------------------------------------------

次に各ファイルの詳細について説明します。


## 5.1 ジャーナルファイル（取引情報）

それぞれ接続するクレジット決済センターによって、以下の取引情報をジャーナルファイルに収集します。\
ジャーナルファイルでは、同一取引番号をもつ要求電文と応答電文を1つのレコード内に記録します。トランザクション単位での記録です。

当ファイルを参照するには専用ツールを使用します。ツールの使用法については「3.6 fxviewコマンド」を参照してください。

------------------------------------------------------------------------

### ■ CARDNET接続サービス 保存対象電文

| 要求 | 応答 | 内容 |
|------|------|------|
| C100 / D100 / Q100 |  | オーソリ |
| C110 / D110 / Q110 |  | オーソリ |
| C120 |  | オーソリアドバイス |
| C130 |  | オーソリアドバイス |
| C200 / D200 |  | 売上 |
| C210 / D210 |  | 売上 |
| C220 |  | 売上アドバイス |
| C230 |  | 売上アドバイス |
| C420 / D420 / Q420 |  | 障害取消アドバイス（再送） |
| C421 / D421 / Q421 |  | 障害取消アドバイス（再送） |
| C430 / D430 / Q430 |  | 障害取消アドバイス |


------------------------------------------------------------------------

### ■ CAFIS接続サービス 保存対象電文

| 要求 | 応答 | 内容 |
|------|------|------|
| 3110 | 3120 / 3150 | 与信 |
| 3210 | 3220 / 3250 | 売上 |
| 3310 | 3320 / 3350 | 取消 |
| 3410 | 3420 / 3450 | 照会 |
| 3510 | 3520 / 3550 | その他 |
| 6110 | 6120 / 6150 | 事故カード中継 |
| 8910 / 8920 | 8930 / 8940 | 取消（再）指令 |
| 8950 |  | 取消報告 |
| 8960 |  | 取消確認報告 |
| 8970 |  | 異常報告 |
---

各トランザクションは、要求電文のカット対象日付を基準にファイルへ書き込まれます。\
オンライン管理対象のジャーナルファイルは **前々日分まで** です。

カット対象日付変更時、前々日分ファイルはファイル中の日付を参照してリネーム後、\
`%FX_ROOT%/journal` 配下へ保管されます。

------------------------------------------------------------------------

### ■ ジャーナルファイル一覧（例：CARDNET）

| 種別     | ファイル名        |
|----------|-------------------|
| 当日     | j1_cn.dat         |
| 前日     | j2_cn.dat         |
| 前々日   | j3_cn.dat         |
| それ以前 | j_cn_yymmdd.dat   |

各ジャーナルファイルには検索高速化のためインデックスファイルが1対1で生成されます。\
作成・切替・削除タイミングはジャーナルファイルと同一です。

| 対応DAT          | INDEX             |
|------------------|-------------------|
| j1_cn.dat        | j1_cn.idx         |
| j_cn_yymmdd.dat  | j_cn_yymmdd.idx   |


------------------------------------------------------------------------

### ■ ファイルフォーマット

ジャーナルヘッダ＋要求電文＋応答電文 で構成される **可変長レコード**。

------------------------------------------------------------------------

### ■ ジャーナルレコードフォーマット

**ヘッダ総計：37 byte**

| 分類 | 項目 | 型 | 説明 |
|------|------|----|------|
| ヘッダ | ヘッダタイプ | char(2) | "J1"固定 |
| ヘッダ | 外部イベントフラグ | char(1) | API送信電文状態 |
| ヘッダ | 内部イベントフラグ | char(1) | Daemon送信電文状態 |
| ヘッダ | 要求受付日時 | char(7 BCD) | YYYY/MM/DD HH:MM:SS |
| ヘッダ | 応答受信日時 | char(7 BCD) | YYYY/MM/DD HH:MM:SS |
| ヘッダ | キャプチャフラグ | char(1) | 0x00未 / 0x01済 |
| ヘッダ | 取消済フラグ | char(1) | 0x00未 / 0x01障害 / 0x02ユーザ |
| ヘッダ | 電文処理通番 | ULONG | 通番 |
| ヘッダ | 電文参照用キー | ULONG | CN: bit11 / CF: 端末通番+処理通番 |
| ヘッダ | 要求元通番 | ULONG | キャプチャ・取消起点 |
| ヘッダ | 要求fXMsg長 | ULONG | 要求長 |
| ヘッダ | 応答fXMsg長 | ULONG | 応答長 |

------------------------------------------------------------------------

### ■ 備考

-   CN = CARDNET接続サービス\
-   CF = CAFIS接続サービス

障害電文送信に対して正常応答を受信した場合のみ、\
取消済フラグは以下になります。

-   0x01：障害取消\
-   0x02：ユーザ取消

## 5.2 精査電文記録ファイル（精査情報）

送受信した精査電文を以下のファイルに記録します。  

```
%FX_ROOT%/log/reconcil_cn_yymmdd.log
%FX_ROOT%/log/reconcil_cf_yymmdd.log
```

参照には専用ツールを使用します。  
ツールの使用方法は **「3.6 fxviewコマンド」** を参照してください。

---

### ■ CARDNET接続サービス 精査記録対象電文

| 要求 | 応答 | 内容 |
|------|------|------|
| C522 |  | 仕向精査 |
| C532 |  | 仕向精査 |

---

### ■ CAFIS接続サービス 精査記録対象電文

| 要求 | 応答 | 内容 |
|------|------|------|
| 3510 | 3520 / 3550 | その他要求（サービス終了指令、サービスカウンタ照会指令）／その他許可報告／その他拒否 |
| 4110 | 4120 | カウンタ通知／カウンタ通知完了報告 |
| 4910 | 4920 | カウンタ照会／カウンタ照会報告 |

※ その他要求電文およびカウンタ通知電文については、  
CAFISセンターおよび被仕向センターを主局とする送受信電文についても記録されます。

---

## ■ 精査電文記録ファイルフォーマット

固定長レコード形式（ヘッダ＋電文本体）で構成されます。  

**ヘッダ総計：58byte**

| 分類 | 項目 | 型 | 説明 |
|------|------|----|------|
| ヘッダ | ヘッダタイプ | CHAR(2) | フォーマット識別子 “R1” 固定 |
| ヘッダ | 電文種別 | CHAR(4) | 電文種別 |
| ヘッダ | 差出センターID | CHAR(11) | CN：指出センターID（共制H） / CF：仕向会社コード＋仕向会社サブコード |
| ヘッダ | 宛先センターID | CHAR(11) | CN：宛先センターID（共制H） / CF：被仕向会社コード＋被仕向会社サブコード |
| ヘッダ | 契約会社コード | CHAR(11) | CN：契約会社コード（共制H） / CF：未使用 |
| ヘッダ | 送信日時 | CHAR(7 BCD) | CN：送信日時（共制H） / CF：送受信日時 YYYY/MM/DD HH:MM:SS |
| ヘッダ | カット対象日付 | CHAR(4 BCD) | カットオーバー日付 |
| ヘッダ | 精査要求fXMsg長 | ULONG | 要求長 |
| ヘッダ | 精査応答fXMsg長 | ULONG | 応答長 |

---

### ■ 電文本体

可変長データ  

- クレジット決済センターへ送信した要求電文  
- またはセンターから受信した応答電文  

---

**注記**

- CN：CARDNET接続サービス  
- CF：CAFIS接続サービス  
- 共制H：共通制御ヘッダ


## 5.3 イベントファイル（管理情報）

送受信された制御電文の記録と、受信電文に対応する送信電文が見つからないため破棄される電文や、FEXICS取扱い対象外の電文（被仕向電文等）などを記録します。  
以下のファイル名で記録されます。

- `%FX_ROOT%/log/event_cn_yymmdd.log`
- `%FX_ROOT%/log/event_cf_yymmdd.log`

当ファイルを参照するには専用ツールを使用します。ツールの使用法については「3.6 fxviewコマンド」を参照してください。

---

### ■ CARDNET接続サービス保存対象電文

| 要求 | 応答 | 内容 |
|------|------|------|
| C804 |      | ネットワーク制御 |
| C814 |      | ネットワーク制御 |
| C644 |      | カットオーバー依頼 |
|      | E644 | 障害電文通知 |

その他、対応する送信電文が見つからず破棄された受信電文や、CARDNETより送信された業務取り扱い対象外の要求電文などについても記録されます。

---

### ■ CAFIS接続サービス保存対象電文

| 要求 | 応答 | 内容 |
|------|------|------|
| 0010 | 7020 | 開始指令（CAFIS送信）／再開始要求（加盟店送信） |
| 0120 | 7110 | 開始準備完了報告／再開始許可指令 |
| 0610 | 0720 | 終了予告指令（CAFIS送信）／終了要求（加盟店送信） |
| 0620 | 0810 | 終了準備完了報告／終了許可指令 |
| 0910 |      | 終了指令 |
| 0920 |      | 終了報告 |
| 9210 |      | 回線障害回復確認指令 |
| 9220 |      | 回線障害回復報告 |

その他、対応する送信電文が見つからず破棄された受信電文や、CAFISセンターより送信された業務取り扱い対象外の要求電文などについても記録されます。

---

## ファイルフォーマット

**制御電文レコードフォーマット（ヘッダ総計66byte）**

| 分類 | 項目 | 属性 | 説明 |
|------|------|------|------|
| ヘッダ | ヘッダタイプ | CHAR(2) | フォーマット識別子 "E1" 固定 |
| | 発生日時 | CHAR(6 BCD) | イベント発生日時 |
| | 電文種別 | CHAR(4) | 電文種別 |
| | 状況 | CHAR(1) | イベントステータス |
| | | | 0x00 制御電文送受信 |
| | | | 0x01 電文破棄（重複） |
| | | | 0x02 電文破棄（対応無し） |
| | | | 0x03 拒否応答電文 |
| | | | 0x04 業務対象外電文 |
| | 差出センターID | CHAR(11) | CN: 指出センターID / CF: 仕向会社コード+サブコード |
| | 宛先センターID | CHAR(11) | CN: 宛先センターID / CF: 被仕向会社コード+サブコード |
| | 契約会社コード | CHAR(11) | CN: 契約会社コード / CF: 未使用 |
| | 送信日時 | CHAR(7 BCD) | CN: 送信日時 / CF: 送受信日時 |
| | カット対象日付 | CHAR(4 BCD) | カットオーバー日付 |
| | 要求fXMsgレングス | ULONG | 要求長 |
| | 応答fXMsgレングス | ULONG | 応答長 |
| | Reserve | CHAR(1) | 予約領域 |

**可変長部**
- 要求fXMsg または 応答fXMsg  
- クレジット決済センター送信要求電文 または 受信応答電文

---

※ クレジット決済センターから送信された制御電文に対し拒否応答を返した場合、イベントステータスは `0x03` となります。
