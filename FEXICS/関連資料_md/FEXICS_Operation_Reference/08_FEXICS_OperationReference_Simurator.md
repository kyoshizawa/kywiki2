# 8. クレジット決済センターエミュレータ

それぞれのクレジット決済センター用のエミュレータを使用して、ローカル環境にてアプリケーションをテストすることが可能です。  
各エミュレータは起動時にライセンスの有無をチェックします。エミュレータを起動させるにはDevelopment Kitのライセンスが必要となります。  
Runtime Kitのライセンスでは起動しません。

## 8.1 CARDNETエミュレータ

cnacenterコマンドラインプログラムを使用して、CARDNETセンターの受信・応答をエミュレートすることができます。  
業務電文の送受信をする前には、かならず開局及びキー交換（KC、KMAC、KPE）を行なってください。

### 8.1.1 fx_cn.cfの設定

cnacenterは、起動時にFEXICS Daemonと同じコンフィグファイルを読み込んで起動します。  

テストエミュレーション用の設定ファイルを「%FX_ROOT%\config\fx_local_cn.cf」に用意してありますので、当ファイルをfx_cn.cfにリネームしてご使用ください。  
その際、本番用の設定ファイル(fx_cn.cf)は、かならず別に保管しておいてください。  

テストを行なう際は、以下の項目をテスト環境に合わせてからご使用ください。

[テスト環境依存項目]

･ MSG_FIELD セクション  
TRANSACTION_DESTINATION_INSTITUTION_ID ： 電文送信先センターID(bit93)  
※ 当項目の設定値に一致しない電文を受信した場合、異常通知電文を送信します。  

TRANSACTION_ORIGINATOR_INSTITUTION_ID ： 電文送信元センターID(bit94)  
※ 当項目の設定値に一致しない電文を受信した場合、異常通知電文を送信します。  

・ SOCKET_PORTセクション  
FXIPC_COM ： FEXICS DaemonとFEXICS APIが通信を行なうポート番号  
FXIPC_FXUMAIN_HOST ： FEXICS Daemonを起動するマシンのIPアドレス  

・ INTERCONNECT．CARDNETセクション  
LOCAL_ADDRESS ： FEXICS Daemonを起動するマシンのIPアドレス（cnacenterの接続先）  
LOCAL_PORT ： cnacenterからの接続要求を受け付けるポート番号  
CENTER_ADDRESS ： cnacenterを起動するマシンのIPアドレス  
CENTER_PORT ： FEXICS Daemonからcnacenterに接続するためのポート番号  

### 8.1.2 KEKの設定

「1.8 CARDNET Service固有の設定項目」を参照してください。

### 8.1.3 操作方法

cnacenterには、対話式に入力できる下記コマンド群が用意されております。すべて、任意のタイミングでの実行が可能です。

[command]

h,?  
コマンドヘルプを出力します  

start  
開局要求を送信します  

end  
閉局要求を送信します  

key  
キー交換（KC、KMAC、KPE）を行ないます  

exit  
cnacenterを終了します  

init  
設定ファイル指定数の接続要求を発行します  

term  
CARDNETコネクションをすべて切断します  

cnterm  
仕向コネクションをすべて切断します  

refresh  
セッションをすべて切断後、リコネクトします  

send <file name> [<count> <interval>]  
<file name>に指定したファイルの内容を送信します  
（<count>送信回数、<interval>送信間隔（msec単位）  
(<count><interval>デフォルト値は送信回数1回、送信間隔0秒)

option  
MTIコード毎の応答電文内容、およびリトリーバルリファレンスナンバー（bit37）の開始番号を設定します。

対話式コマンド「option」を実行した場合、MTIコード毎に応答内容を設定するための下記メッセージが出力されます。  
指定するMTIコードは、FEXICSが送信する要求電文の値です。

[option設定]

返信アクションコードをオーバーライドするMTIの設定  

MTIコード(n4) ： 返信アクションを指定したい要求電文のMTIコード[4桁]を指定します  

all ： 全ての応答電文に対し、同じ返信アクションを指定します  
end ： 返信アクションコードの設定を終了します  

返信アクションコードの設定  

アクションコード(n3) ： 返信するアクションコード（bit39）[3桁]を指定します  

err ： “E644”を返信します  
ign ： 応答電文を送信しません  
dly ： 応答電文の返信を遅延させます(単位；秒)  
clr ： 応答電文のoption設定をクリアします  
num ： 任意の承認コード（bit38）を設定します  
rsp ： 国内レスポンスコード（bit48）の応答コードを設定します  

シーケンス初期値の設定  

シーケンス初期値 ： cnacenterが設定するリトリーバルリファレンスナンバー(bit37)の開始番号を指定します。  
値の入力をスキップして[ENTER]キーを押すと、optionコマンド実行前の値から継続して採番されます。

[出力例]

```
C:\>cnacenter  
CNセンターエミュレータ Ver.4.0.0  
>start  
>option  
オプションを設定します  
返信アクションコードをオーバーライドするMTI(n4 全て=all 終了=end):1100  
返信アクションコード(n3 エラー返信=err,無視=ign,遅延=dly,削除=clr,承認=num,応答=rsp):100  
返信アクションコードをオーバーライドするMTI(n4 全て=all 終了=end):1200  
返信アクションコード(n3 エラー返信=err,無視=ign,遅延=dly,削除=clr,承認=num,応答=rsp):ign  
返信アクションコードをオーバーライドするMTI(n4 全て=all 終了=end):end  
シーケンス初期値(1<=n<=999999):1  
>
```

### 8.1.4 電文チェック機能

cnacenterは、受信電文の以下の内容を確認します。

・ 暗号の復号化  
・ チェックデジット  
・ 差出センターID  
・ 宛先センターID  
・ セキュリティ関連制御情報（bit53）  
・ 可変長項目のレングス値  
・ IC関連データ（bit55）  

IC関連データについては、IC関連データ中の、タグ4F「Application Identifier」または、84「Dedicated File Name」の内容をチェックしてICブランドの判別を行います。さらに応答電文のアクションコードのチェックを行い、各ICブランド毎および設定アクションコードに対応したIC関連データのタグ8A「Authorization Response Code」をセットして応答電文を送信します。  

当チェック機能は、optionコマンドによる返信アクションコードの設定に対応しています。

各ICブランドおよび、アクションコード毎に応答電文にセットされるARCは以下の通りです。

| アクションコード | ARCのコード値 | 内容 | JCB | VISA | MASTER | AMEX | Diners | D/Smart |
|----------------|---------------|------|-----|------|--------|------|--------|--------|
| 000 | 00 | 承認許可 | 00 | 00 | 00 | 00 | 00 | 00 |
| 100 | 05 | 取扱拒否 | 05 | 05 | 05 | 05 | 10 | 05 |
| 103 | 01 | 取扱保留、アクアイアラへ連絡 | 01 | 01 | 01 | 01 | 01 | 01 |
| 200 | 04 | カード回収、アクアイアラへ連絡 | 04 | 04 | 04 | 04 | 11 | 04 |
| 909 | 91 | 障害中(システム不調) | 91 | 91 | 91 | 91 | 10 | 91 |
| その他 | 05 |  | 05 | 05 | 05 | 05 | 10 | 05 |

ARCのコード値が示す内容は以下の通りとなります。

| ARCコード値 | 内容 |
|-------------|------|
| 00 | Approved or completed successfully |
| 01 | Refer to card issuer |
| 04 | Pick – up |
| 05 | Do not honour |
| 10 | Online Declined |
| 11 | Capture the Card |
| 91 | Issuer or switch is inoperative |

### 8.1.5 その他の機能

cnacenterは、各種電文の受信・応答の他に下記の機能を持ちます。

自動接続要求 ： 起動時に、コンフィグファイルに設定しているFEXICS Daemonへ接続要求を発行します。  
自動精査要求 ： カットオーバー応答を受信した際に、受信から10秒後に自動で精査要求を発行します。

### 8.1.6 出力ファイル

cnacenterに関する簡単なシステム情報、およびエラー情報は、下記ファイルに出力されます。

[ファイル名]

cnacenter.stdtxt ： cnacenterに関するシステム情報  
cnacenter.errtxt ： cnacenterに関するエラー情報  

